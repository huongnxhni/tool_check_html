<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ So sánh và Tối ưu HTML/CSS/JS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/vs2015.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/xml.min.js"></script>
    <style>
        :root {
            --vs-bg: #1e1e1e;
            --vs-sidebar: #252526;
            --vs-active-tab: #1e1e1e;
            --vs-inactive-tab: #2d2d2d;
            --vs-text: #d4d4d4;
            --vs-text-secondary: #858585;
            --vs-border: #3e3e3e;
            --vs-accent: #007acc;
            --vs-accent-light: #3794ff;
            --vs-green: #4EC9B0;
            --vs-yellow: #FFCC66;
            --vs-orange: #CE9178;
            --vs-red: #F44747;
            --vs-purple: #C586C0;
            --vs-blue: #569CD6;
            --vs-comment: #6A9955;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--vs-text);
            background-color: var(--vs-bg);
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr;
            height: 100vh;
        }

        header {
            grid-column: 1 / -1;
            background-color: var(--vs-sidebar);
            padding: 15px 25px;
            border-bottom: 1px solid var(--vs-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: var(--vs-text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .description {
            font-size: 0.9rem;
            color: var(--vs-text-secondary);
        }

        .quick-actions {
            display: flex;
            gap: 10px;
        }

        .input-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-column: 1 / -1;
            height: 100%;
        }

        .file-input {
            background-color: var(--vs-bg);
            border-right: 1px solid var(--vs-border);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .file-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background-color: var(--vs-sidebar);
            border-bottom: 1px solid var(--vs-border);
        }

        .file-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--vs-text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .upload-area {
            border: 2px dashed var(--vs-border);
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            margin: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: rgba(255, 255, 255, 0.02);
        }

        .upload-area:hover {
            border-color: var(--vs-accent);
            background-color: rgba(0, 122, 204, 0.05);
        }

        .upload-area.dragover {
            border-color: var(--vs-accent);
            background-color: rgba(0, 122, 204, 0.1);
        }

        .upload-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--vs-text-secondary);
        }

        .file-content-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin: 0 15px 15px;
            border: 1px solid var(--vs-border);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .file-content-header {
            background-color: var(--vs-sidebar);
            padding: 8px 15px;
            border-bottom: 1px solid var(--vs-border);
            font-size: 0.9rem;
            color: var(--vs-text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .code-editor {
            flex: 1;
            position: relative;
            overflow: hidden;
            max-height: 400px;
        }

        .line-numbers {
            position: absolute;
            left: 0;
            top: 0;
            width: 50px;
            height: 100%;
            background-color: var(--vs-sidebar);
            border-right: 1px solid var(--vs-border);
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            color: var(--vs-text-secondary);
            padding: 15px 5px;
            line-height: 1.5;
            text-align: right;
            user-select: none;
            overflow: hidden;
            z-index: 1;
        }

        .file-content {
            flex: 1;
            padding: 15px 15px 15px 65px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            background-color: var(--vs-bg);
            color: var(--vs-text);
            border: none;
            resize: none;
            outline: none;
            width: 100%;
            min-height: 300px;
            max-height: 400px;
            overflow: auto;
            tab-size: 4;
            position: relative;
            z-index: 2;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .file-content:focus {
            background-color: rgba(0, 122, 204, 0.02);
        }

        .file-content-preview {
            flex: 1;
            padding: 15px 15px 15px 65px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            background-color: var(--vs-bg);
            color: var(--vs-text);
            max-height: 400px;
            overflow: auto;
            white-space: pre-wrap;
            position: relative;
            word-break: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .file-content-preview code {
            background: transparent !important;
            padding: 0 !important;
        }

        .hljs {
            background: transparent !important;
            padding: 0 !important;
        }

        .file-info {
            padding: 10px 15px;
            background-color: var(--vs-sidebar);
            border-top: 1px solid var(--vs-border);
            font-size: 0.85rem;
            color: var(--vs-text-secondary);
        }

        .button-group {
            display: flex;
            gap: 8px;
            padding: 15px;
            border-top: 1px solid var(--vs-border);
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-primary {
            background: var(--vs-accent);
            color: white;
        }

        .btn-success {
            background: var(--vs-green);
            color: var(--vs-bg);
        }

        .btn-warning {
            background: var(--vs-yellow);
            color: var(--vs-bg);
        }

        .btn-danger {
            background: var(--vs-red);
            color: white;
        }

        .btn-info {
            background: var(--vs-purple);
            color: white;
        }

        .results-section {
            grid-column: 1 / -1;
            background-color: var(--vs-bg);
            display: flex;
            flex-direction: column;
            height: 100%;
            border-top: 1px solid var(--vs-border);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background-color: var(--vs-sidebar);
            border-bottom: 1px solid var(--vs-border);
        }

        .results-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--vs-text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 15px;
            background-color: var(--vs-sidebar);
            border-bottom: 1px solid var(--vs-border);
        }

        .stat-card {
            background: var(--vs-bg);
            border-radius: 4px;
            padding: 15px;
            text-align: center;
            border: 1px solid var(--vs-border);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--vs-text-secondary);
            font-weight: 600;
        }

        .css-stat .stat-value {
            color: var(--vs-orange);
        }

        .js-stat .stat-value {
            color: var(--vs-yellow);
        }

        .duplicate-stat .stat-value {
            color: var(--vs-red);
        }

        .missing-stat .stat-value {
            color: var(--vs-green);
        }

        .tabs {
            display: flex;
            background-color: var(--vs-sidebar);
            border-bottom: 1px solid var(--vs-border);
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--vs-text-secondary);
            background-color: var(--vs-inactive-tab);
        }

        .tab.active {
            border-bottom: 2px solid var(--vs-accent);
            color: var(--vs-text);
            background-color: var(--vs-active-tab);
        }

        .tab:hover {
            color: var(--vs-text);
            background-color: var(--vs-active-tab);
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow: auto;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .analysis-card {
            background-color: var(--vs-sidebar);
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid var(--vs-border);
        }

        .analysis-header {
            padding: 12px 15px;
            background-color: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid var(--vs-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .analysis-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--vs-text);
        }

        .analysis-content {
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.5;
            max-height: 400px;
            overflow-y: auto;
        }

        .analysis-section {
            margin-bottom: 15px;
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--vs-accent-light);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .section-content {
            padding-left: 15px;
            font-size: 0.9rem;
        }

        .item-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .item-tag {
            background-color: rgba(0, 122, 204, 0.2);
            border: 1px solid rgba(0, 122, 204, 0.3);
            border-radius: 3px;
            padding: 3px 8px;
            font-size: 0.8rem;
            color: var(--vs-accent-light);
        }

        .item-tag.unused {
            background-color: rgba(244, 71, 71, 0.2);
            border-color: rgba(244, 71, 71, 0.3);
            color: var(--vs-red);
        }

        .item-tag.duplicate {
            background-color: rgba(255, 204, 102, 0.2);
            border-color: rgba(255, 204, 102, 0.3);
            color: var(--vs-yellow);
        }

        .comparison-result {
            background-color: var(--vs-sidebar);
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--vs-border);
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .comparison-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--vs-text);
        }

        .comparison-content {
            font-family: 'Consolas', 'Monaco', monospace;
            background-color: var(--vs-bg);
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--vs-border);
            line-height: 1.6;
            font-size: 13px;
        }

        .code-diff {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .code-side {
            border: 1px solid var(--vs-border);
            border-radius: 4px;
            overflow: hidden;
        }

        .code-side-header {
            background-color: var(--vs-sidebar);
            padding: 8px 12px;
            border-bottom: 1px solid var(--vs-border);
            font-weight: 600;
            color: var(--vs-text);
            font-size: 0.9rem;
        }

        .code-side-content {
            padding: 12px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            background: var(--vs-bg);
            line-height: 1.4;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background-color: var(--vs-green);
            color: var(--vs-bg);
        }

        .badge-warning {
            background-color: var(--vs-yellow);
            color: var(--vs-bg);
        }

        .badge-danger {
            background-color: var(--vs-red);
            color: white;
        }

        .badge-info {
            background-color: var(--vs-purple);
            color: white;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 18px;
            border-radius: 4px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            font-size: 0.9rem;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--vs-green);
            color: var(--vs-bg);
        }

        .notification.error {
            background: var(--vs-red);
            color: white;
        }

        .notification.warning {
            background: var(--vs-yellow);
            color: var(--vs-bg);
        }

        .notification.info {
            background: var(--vs-accent);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--vs-text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .input-mode-toggle {
            display: flex;
            gap: 10px;
            margin: 0 15px 10px;
        }

        .mode-btn {
            padding: 6px 12px;
            border: 1px solid var(--vs-border);
            background: var(--vs-sidebar);
            color: var(--vs-text-secondary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .mode-btn.active {
            background: var(--vs-accent);
            color: white;
            border-color: var(--vs-accent);
        }

        /* Text Diff Styles - Improved */
        .text-diff-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            margin-top: 20px;
            height: 600px;
            border: 1px solid var(--vs-border);
            border-radius: 4px;
            overflow: hidden;
        }

        .diff-side {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .diff-side:first-child {
            border-right: 1px solid var(--vs-border);
        }

        .diff-side-header {
            background-color: var(--vs-sidebar);
            padding: 10px 15px;
            border-bottom: 1px solid var(--vs-border);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .diff-content-wrapper {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .diff-line-numbers {
            width: 50px;
            background-color: var(--vs-sidebar);
            border-right: 1px solid var(--vs-border);
            color: var(--vs-text-secondary);
            padding: 15px 5px;
            line-height: 1.5;
            text-align: right;
            user-select: none;
            overflow: hidden;
            z-index: 1;
            flex-shrink: 0;
        }

        .diff-text {
            flex: 1;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            overflow: auto;
            white-space: pre;
            word-wrap: break-word;
            position: relative;
            z-index: 2;
        }

        .diff-line {
            min-height: 19px;
            padding: 0 5px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        .diff-added {
            background-color: rgba(78, 201, 176, 0.15);
            border-left: 3px solid var(--vs-green);
        }

        .diff-removed {
            background-color: rgba(244, 71, 71, 0.15);
            border-left: 3px solid var(--vs-red);
        }

        .diff-unchanged {
            border-left: 3px solid transparent;
        }

        .diff-modified {
            background-color: rgba(255, 204, 102, 0.15);
            border-left: 3px solid var(--vs-yellow);
        }

        .diff-info {
            display: flex;
            gap: 10px;
            font-size: 0.8rem;
            color: var(--vs-text-secondary);
        }

        .diff-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: var(--vs-sidebar);
            border-radius: 4px;
            border: 1px solid var(--vs-border);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .stat-dot.added {
            background: var(--vs-green);
        }

        .stat-dot.removed {
            background: var(--vs-red);
        }

        .stat-dot.modified {
            background: var(--vs-yellow);
        }

        .stat-dot.unchanged {
            background: var(--vs-text-secondary);
        }

        .diff-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .toolbar-btn {
            padding: 6px 12px;
            border: 1px solid var(--vs-border);
            background: var(--vs-sidebar);
            color: var(--vs-text);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .toolbar-btn:hover {
            background: var(--vs-accent);
            color: white;
        }

        .inline-diff {
            display: inline;
        }

        .inline-added {
            background-color: rgba(78, 201, 176, 0.3);
            color: var(--vs-green);
            padding: 1px 2px;
            border-radius: 2px;
        }

        .inline-removed {
            background-color: rgba(244, 71, 71, 0.3);
            color: var(--vs-red);
            text-decoration: line-through;
            padding: 1px 2px;
            border-radius: 2px;
        }

        .sync-scroll-container {
            position: relative;
            overflow: auto;
        }

        /* NEW: Optimization Panel Styles */
        .optimization-panel {
            background: var(--vs-sidebar);
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--vs-border);
        }

        .optimization-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .optimization-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--vs-text);
        }

        .optimization-actions {
            display: flex;
            gap: 8px;
        }

        .optimization-list {
            max-height: 200px;
            overflow-y: auto;
            background: var(--vs-bg);
            border-radius: 4px;
            border: 1px solid var(--vs-border);
        }

        .optimization-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid var(--vs-border);
        }

        .optimization-item:last-child {
            border-bottom: none;
        }

        .optimization-item-info {
            flex: 1;
        }

        .optimization-item-name {
            font-weight: 600;
            color: var(--vs-text);
        }

        .optimization-item-desc {
            font-size: 0.8rem;
            color: var(--vs-text-secondary);
        }

        .optimization-item-actions {
            display: flex;
            gap: 5px;
        }

        .merge-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .merge-btn {
            padding: 6px 12px;
            border: 1px solid var(--vs-border);
            background: var(--vs-sidebar);
            color: var(--vs-text);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .merge-btn:hover {
            background: var(--vs-accent);
            color: white;
        }

        .merge-btn.merge-left::before {
            content: "←";
        }

        .merge-btn.merge-right::before {
            content: "→";
        }

        /* NEW: Interactive Diff Styles */
        .diff-line.interactive {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .diff-line.interactive:hover {
            background-color: rgba(0, 122, 204, 0.1);
        }

        .diff-line.selected {
            background-color: rgba(0, 122, 204, 0.2);
            border-left: 3px solid var(--vs-accent);
        }

        .merge-controls {
            position: absolute;
            top: 5px;
            right: 5px;
            display: none;
            gap: 5px;
        }

        .diff-line:hover .merge-controls {
            display: flex;
        }

        .merge-control-btn {
            padding: 2px 6px;
            background: var(--vs-accent);
            color: white;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 0.7rem;
        }

        /* NEW: File comparison specific styles */
        .file-comparison-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .comparison-section {
            background: var(--vs-sidebar);
            border-radius: 4px;
            padding: 15px;
            border: 1px solid var(--vs-border);
        }

        .comparison-section-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .comparison-section-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--vs-text);
        }

        .comparison-details {
            background: var(--vs-bg);
            border-radius: 4px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--vs-border);
        }

        .comparison-item {
            padding: 8px;
            border-bottom: 1px solid var(--vs-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comparison-item:last-child {
            border-bottom: none;
        }

        .comparison-item-name {
            font-weight: 500;
            color: var(--vs-text);
        }

        .comparison-item-status {
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .status-present {
            background: var(--vs-green);
            color: var(--vs-bg);
        }

        .status-missing {
            background: var(--vs-red);
            color: white;
        }

        .status-different {
            background: var(--vs-yellow);
            color: var(--vs-bg);
        }

        /* NEW: Merge Functions Section */
        .merge-functions-section {
            margin-top: 20px;
        }

        .merge-function-item {
            background: var(--vs-sidebar);
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--vs-border);
        }

        .merge-function-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .merge-function-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--vs-text);
        }

        .merge-function-type {
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 3px;
            background: var(--vs-purple);
            color: white;
        }

        .merge-function-actions {
            display: flex;
            gap: 8px;
        }

        .merge-preview {
            background: var(--vs-bg);
            border-radius: 4px;
            padding: 12px;
            margin-top: 10px;
            border: 1px solid var(--vs-border);
            max-height: 200px;
            overflow-y: auto;
        }

        .merge-preview-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--vs-accent-light);
        }

        .merge-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .merge-option {
            flex: 1;
            text-align: center;
            padding: 8px;
            border: 1px solid var(--vs-border);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .merge-option:hover {
            background: var(--vs-accent);
            color: white;
        }

        .merge-option.selected {
            background: var(--vs-accent);
            color: white;
            border-color: var(--vs-accent);
        }

        @media (max-width: 1200px) {
            .input-section {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .analysis-grid {
                grid-template-columns: 1fr;
            }

            .code-diff,
            .text-diff-container {
                grid-template-columns: 1fr;
            }

            .file-comparison-view {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                grid-template-rows: auto auto 1fr;
            }

            header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .quick-actions {
                width: 100%;
                justify-content: space-between;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .file-header,
            .results-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .file-actions,
            .button-group {
                width: 100%;
                justify-content: space-between;
            }

            button {
                flex: 1;
                justify-content: center;
            }

            .merge-function-actions {
                flex-direction: column;
            }
        }

        .code-editor {
            display: flex;
            position: relative;
            overflow: hidden;
        }

        .line-numbers {
            flex-shrink: 0;
            width: 50px;
            background-color: var(--vs-sidebar);
            border-right: 1px solid var(--vs-border);
            color: var(--vs-text-secondary);
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            padding: 15px 5px;
            text-align: right;
            overflow: hidden;
        }

        .file-content-preview {
            flex: 1;
            overflow: auto;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            background-color: var(--vs-bg);
            color: var(--vs-text);
            white-space: pre-wrap;
            word-break: break-word;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div>
                <h1>⚡ Công cụ So sánh và Tối ưu HTML/CSS/JS</h1>
                <p class="description">Phân tích, so sánh và tối ưu hóa code HTML, CSS và JavaScript</p>
            </div>
            <div class="quick-actions">
                <button class="btn-success" onclick="analyzeBothFiles()">
                    🔍 Phân tích Cả Hai File
                </button>
                <button class="btn-warning" onclick="clearBothFiles()">
                    🗑️ Xóa Tất Cả
                </button>
            </div>
        </header>

        <div class="input-section">
            <div class="file-input">
                <div class="file-header">
                    <div class="file-title">
                        📄 File HTML 1
                        <span class="badge badge-info" id="file1-stats">Chưa có nội dung</span>
                    </div>
                    <div class="file-actions">
                        <button class="btn-primary" onclick="analyzeFile(1)" id="analyze-btn-1">
                            🔍 Phân tích
                        </button>
                        <button class="btn-danger" onclick="optimizeFile(1)" id="optimize-btn-1">
                            🧹 Tối ưu
                        </button>
                    </div>
                </div>

                <div class="input-mode-toggle">
                    <button class="mode-btn active" id="mode-file1-file" onclick="switchInputMode(1, 'file')">📁 Từ
                        File</button>
                    <button class="mode-btn" id="mode-file1-text" onclick="switchInputMode(1, 'text')">📝 Nhập
                        Code</button>
                </div>

                <div class="upload-area" id="upload-area-1" onclick="document.getElementById('file1').click()">
                    <div class="upload-icon">📁</div>
                    <p>Nhấn để chọn file hoặc kéo thả file HTML vào đây</p>
                    <p><small>Chấp nhận: .html, .htm</small></p>
                    <input type="file" id="file1" accept=".html,.htm" style="display: none"
                        onchange="handleFileSelect(1, this.files[0])">
                </div>

                <div class="file-content-container" id="text-input-1" style="display: none;">
                    <div class="file-content-header">
                        <span>Nhập code HTML trực tiếp</span>
                        <span id="file1-lines">0 dòng</span>
                    </div>
                    <div class="code-editor">
                        <div class="line-numbers" id="line-numbers-1">1</div>
                        <textarea class="file-content" id="file-content-text-1"
                            placeholder="Nhập code HTML, CSS, JavaScript vào đây..." oninput="updateLineCount(1)"
                            onscroll="syncScroll(1)"></textarea>
                    </div>
                </div>

                <!-- Preview container for file mode -->
                <div class="file-content-container" id="preview-container-1">
                    <div class="file-content-header">
                        <span>Nội dung file</span>
                        <span id="preview1-lines">0 dòng</span>
                    </div>
                    <div class="code-editor">
                        <div class="line-numbers" id="preview-line-numbers-1">1</div>
                        <pre class="file-content-preview" id="file-content-preview-1" onscroll="syncPreviewScroll(1)">
                            <code class="language-html"></code>
                        </pre>
                    </div>
                </div>

                <div class="file-info" id="file-info-1"></div>
                <div class="button-group">
                    <button class="btn-warning" onclick="clearFile(1)">
                        🗑️ Xóa
                    </button>
                    <button class="btn-success" onclick="saveChanges(1)">
                        💾 Lưu Thay Đổi
                    </button>
                </div>
            </div>

            <div class="file-input">
                <div class="file-header">
                    <div class="file-title">
                        📄 File HTML 2
                        <span class="badge badge-info" id="file2-stats">Chưa có nội dung</span>
                    </div>
                    <div class="file-actions">
                        <button class="btn-primary" onclick="analyzeFile(2)" id="analyze-btn-2">
                            🔍 Phân tích
                        </button>
                        <button class="btn-danger" onclick="optimizeFile(2)" id="optimize-btn-2">
                            🧹 Tối ưu
                        </button>
                    </div>
                </div>

                <div class="input-mode-toggle">
                    <button class="mode-btn active" id="mode-file2-file" onclick="switchInputMode(2, 'file')">📁 Từ
                        File</button>
                    <button class="mode-btn" id="mode-file2-text" onclick="switchInputMode(2, 'text')">📝 Nhập
                        Code</button>
                </div>

                <div class="upload-area" id="upload-area-2" onclick="document.getElementById('file2').click()">
                    <div class="upload-icon">📁</div>
                    <p>Nhấn để chọn file hoặc kéo thả file HTML vào đây</p>
                    <p><small>Chấp nhận: .html, .htm</small></p>
                    <input type="file" id="file2" accept=".html,.htm" style="display: none"
                        onchange="handleFileSelect(2, this.files[0])">
                </div>

                <div class="file-content-container" id="text-input-2" style="display: none;">
                    <div class="file-content-header">
                        <span>Nhập code HTML trực tiếp</span>
                        <span id="file2-lines">0 dòng</span>
                    </div>
                    <div class="code-editor">
                        <div class="line-numbers" id="line-numbers-2">1</div>
                        <textarea class="file-content" id="file-content-text-2"
                            placeholder="Nhập code HTML, CSS, JavaScript vào đây..." oninput="updateLineCount(2)"
                            onscroll="syncScroll(2)"></textarea>
                    </div>
                </div>

                <!-- Preview container for file mode -->
                <div class="file-content-container" id="preview-container-2">
                    <div class="file-content-header">
                        <span>Nội dung file</span>
                        <span id="preview2-lines">0 dòng</span>
                    </div>
                    <div class="code-editor">
                        <div class="line-numbers" id="preview-line-numbers-2">1</div>
                        <pre class="file-content-preview" id="file-content-preview-2" onscroll="syncPreviewScroll(2)">
                            <code class="language-html"></code>
                        </pre>

                    </div>
                </div>

                <div class="file-info" id="file-info-2"></div>
                <div class="button-group">
                    <button class="btn-warning" onclick="clearFile(2)">
                        🗑️ Xóa
                    </button>
                    <button class="btn-success" onclick="saveChanges(2)">
                        💾 Lưu Thay Đổi
                    </button>
                </div>
            </div>
        </div>

        <div class="results-section">
            <div class="results-header">
                <div class="results-title">
                    📊 Kết quả phân tích & So sánh
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="btn-info" onclick="switchTab('text-diff')">
                        📝 So sánh Text
                    </button>
                    <button class="btn-success" onclick="compareFiles()" id="compare-btn">
                        ⚡ So sánh hai file
                    </button>
                </div>
            </div>


            <div class="stats">
                <div class="stat-card css-stat">
                    <div class="stat-value" id="cssCount">0</div>
                    <div class="stat-label">CSS Selectors</div>
                </div>
                <div class="stat-card js-stat">
                    <div class="stat-value" id="jsCount">0</div>
                    <div class="stat-label">JS Functions</div>
                </div>
                <div class="stat-card duplicate-stat">
                    <div class="stat-value" id="duplicateCount">0</div>
                    <div class="stat-label">Trùng lặp</div>
                </div>
                <div class="stat-card missing-stat">
                    <div class="stat-value" id="missingCount">0</div>
                    <div class="stat-label">Thiếu & Khác biệt</div>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('analysis')">Phân tích từng File</div>
                <div class="tab" onclick="switchTab('optimization')">🧹 Tối ưu hóa</div>
                <div class="tab" onclick="switchTab('file-comparison')">📊 So sánh File</div>
                <div class="tab" onclick="switchTab('merge-functions')">🔄 Merge Hàm</div>
                <div class="tab" onclick="switchTab('duplicates')">Trùng lặp</div>
                <div class="tab" onclick="switchTab('similar')">Tương tự</div>
                <div class="tab" onclick="switchTab('missing')">Thiếu & Thừa</div>
                <div class="tab" onclick="switchTab('text-diff')">So sánh Text</div>
            </div>

            <div class="tab-content active" id="analysis-tab">
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <div class="analysis-header">
                            <div class="analysis-title">Phân tích File 1</div>
                            <span class="badge badge-info" id="analysis-1-count">Chưa phân tích</span>
                        </div>
                        <div class="analysis-content" id="analysis1">
                            <div class="empty-state">
                                <div class="empty-state-icon">📄</div>
                                <p>Chưa có dữ liệu. Vui lòng upload và phân tích File 1.</p>
                            </div>
                        </div>
                    </div>

                    <div class="analysis-card">
                        <div class="analysis-header">
                            <div class="analysis-title">Phân tích File 2</div>
                            <span class="badge badge-info" id="analysis-2-count">Chưa phân tích</span>
                        </div>
                        <div class="analysis-content" id="analysis2">
                            <div class="empty-state">
                                <div class="empty-state-icon">📄</div>
                                <p>Chưa có dữ liệu. Vui lòng upload và phân tích File 2.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW: Optimization Tab -->
            <div class="tab-content" id="optimization-tab">
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <div class="analysis-header">
                            <div class="analysis-title">Tối ưu File 1</div>
                            <span class="badge badge-info" id="optimization-1-count">Chưa phân tích</span>
                        </div>
                        <div class="analysis-content">
                            <div class="optimization-panel">
                                <div class="optimization-header">
                                    <div class="optimization-title">CSS Selectors không sử dụng</div>
                                    <div class="optimization-actions">
                                        <button class="btn-danger" onclick="removeUnusedCSS(1)">
                                            🗑️ Xóa Tất Cả
                                        </button>
                                    </div>
                                </div>
                                <div class="optimization-list" id="unused-css-1">
                                    <div class="empty-state">
                                        <div class="empty-state-icon">🔍</div>
                                        <p>Chưa có dữ liệu. Vui lòng phân tích File 1.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="optimization-panel">
                                <div class="optimization-header">
                                    <div class="optimization-title">JavaScript Functions không sử dụng</div>
                                    <div class="optimization-actions">
                                        <button class="btn-danger" onclick="removeUnusedJS(1)">
                                            🗑️ Xóa Tất Cả
                                        </button>
                                    </div>
                                </div>
                                <div class="optimization-list" id="unused-js-1">
                                    <div class="empty-state">
                                        <div class="empty-state-icon">🔍</div>
                                        <p>Chưa có dữ liệu. Vui lòng phân tích File 1.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="optimization-panel">
                                <div class="optimization-header">
                                    <div class="optimization-title">CSS Selectors trùng lặp</div>
                                    <div class="optimization-actions">
                                        <button class="btn-warning" onclick="removeDuplicateCSS(1)">
                                            🧹 Gộp Trùng Lặp
                                        </button>
                                    </div>
                                </div>
                                <div class="optimization-list" id="duplicate-css-1">
                                    <div class="empty-state">
                                        <div class="empty-state-icon">🔍</div>
                                        <p>Chưa có dữ liệu. Vui lòng phân tích File 1.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="analysis-card">
                        <div class="analysis-header">
                            <div class="analysis-title">Tối ưu File 2</div>
                            <span class="badge badge-info" id="optimization-2-count">Chưa phân tích</span>
                        </div>
                        <div class="analysis-content">
                            <div class="optimization-panel">
                                <div class="optimization-header">
                                    <div class="optimization-title">CSS Selectors không sử dụng</div>
                                    <div class="optimization-actions">
                                        <button class="btn-danger" onclick="removeUnusedCSS(2)">
                                            🗑️ Xóa Tất Cả
                                        </button>
                                    </div>
                                </div>
                                <div class="optimization-list" id="unused-css-2">
                                    <div class="empty-state">
                                        <div class="empty-state-icon">🔍</div>
                                        <p>Chưa có dữ liệu. Vui lòng phân tích File 2.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="optimization-panel">
                                <div class="optimization-header">
                                    <div class="optimization-title">JavaScript Functions không sử dụng</div>
                                    <div class="optimization-actions">
                                        <button class="btn-danger" onclick="removeUnusedJS(2)">
                                            🗑️ Xóa Tất Cả
                                        </button>
                                    </div>
                                </div>
                                <div class="optimization-list" id="unused-js-2">
                                    <div class="empty-state">
                                        <div class="empty-state-icon">🔍</div>
                                        <p>Chưa có dữ liệu. Vui lòng phân tích File 2.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="optimization-panel">
                                <div class="optimization-header">
                                    <div class="optimization-title">CSS Selectors trùng lặp</div>
                                    <div class="optimization-actions">
                                        <button class="btn-warning" onclick="removeDuplicateCSS(2)">
                                            🧹 Gộp Trùng Lặp
                                        </button>
                                    </div>
                                </div>
                                <div class="optimization-list" id="duplicate-css-2">
                                    <div class="empty-state">
                                        <div class="empty-state-icon">🔍</div>
                                        <p>Chưa có dữ liệu. Vui lòng phân tích File 2.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW: File Comparison Tab -->
            <div class="tab-content" id="file-comparison-tab">
                <div class="file-comparison-view">
                    <div class="comparison-section">
                        <div class="comparison-section-header">
                            <div class="comparison-section-title">So sánh CSS Selectors</div>
                            <span class="badge badge-info" id="comparison-css-count">0 items</span>
                        </div>
                        <div class="comparison-details" id="css-comparison-details">
                            <div class="empty-state">
                                <div class="empty-state-icon">🔍</div>
                                <p>Chưa có dữ liệu. Vui lòng phân tích cả hai file.</p>
                            </div>
                        </div>
                    </div>

                    <div class="comparison-section">
                        <div class="comparison-section-header">
                            <div class="comparison-section-title">So sánh JavaScript Functions</div>
                            <span class="badge badge-info" id="comparison-js-count">0 items</span>
                        </div>
                        <div class="comparison-details" id="js-comparison-details">
                            <div class="empty-state">
                                <div class="empty-state-icon">🔍</div>
                                <p>Chưa có dữ liệu. Vui lòng phân tích cả hai file.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="comparison-result" style="margin-top: 20px;">
                    <div class="comparison-header">
                        <div class="comparison-title">Tổng quan so sánh</div>
                        <span class="badge badge-info" id="overall-comparison-count">Chưa so sánh</span>
                    </div>
                    <div class="comparison-content" id="overall-comparison">
                        <div class="empty-state">
                            <div class="empty-state-icon">📊</div>
                            <p>Chưa có dữ liệu. Vui lòng phân tích cả hai file.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW: Merge Functions Tab -->
            <div class="tab-content" id="merge-functions-tab">
                <div class="comparison-result">
                    <div class="comparison-header">
                        <div class="comparison-title">🔄 Merge Hàm JavaScript & CSS</div>
                        <div class="merge-function-actions">
                            <button class="btn-success" onclick="mergeAllFunctions('1to2')">
                                📤 Merge Tất Cả 1→2
                            </button>
                            <button class="btn-success" onclick="mergeAllFunctions('2to1')">
                                📥 Merge Tất Cả 2→1
                            </button>
                        </div>
                    </div>
                    <div class="comparison-content">
                        <div id="merge-functions-list">
                            <div class="empty-state">
                                <div class="empty-state-icon">🔍</div>
                                <p>Chưa có dữ liệu. Vui lòng phân tích cả hai file để xem các hàm có thể merge.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="duplicates-tab">
                <div class="comparison-result">
                    <div class="comparison-header">
                        <div class="comparison-title">CSS Selectors trùng lặp hoàn toàn</div>
                        <span class="badge badge-warning" id="exact-css-count">0 phần tử</span>
                    </div>
                    <div class="comparison-content" id="exactDuplicateCss">
                        <div class="empty-state">
                            <div class="empty-state-icon">🔍</div>
                            <p>Chưa có dữ liệu. Vui lòng phân tích cả hai file.</p>
                        </div>
                    </div>
                </div>

                <div class="comparison-result">
                    <div class="comparison-header">
                        <div class="comparison-title">JavaScript Functions trùng lặp hoàn toàn</div>
                        <span class="badge badge-warning" id="exact-js-count">0 phần tử</span>
                    </div>
                    <div class="comparison-content" id="exactDuplicateJs">
                        <div class="empty-state">
                            <div class="empty-state-icon">🔍</div>
                            <p>Chưa có dữ liệu. Vui lòng phân tích cả hai file.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="similar-tab">
                <div class="comparison-result">
                    <div class="comparison-header">
                        <div class="comparison-title">CSS Selectors tương tự nhưng khác biệt</div>
                        <span class="badge badge-info" id="similar-css-count">0 phần tử</span>
                    </div>
                    <div class="comparison-content" id="similarCss">
                        <div class="empty-state">
                            <div class="empty-state-icon">🔍</div>
                            <p>Chưa có dữ liệu. Vui lòng phân tích cả hai file.</p>
                        </div>
                    </div>
                </div>

                <div class="comparison-result">
                    <div class="comparison-header">
                        <div class="comparison-title">JavaScript Functions tương tự nhưng khác biệt</div>
                        <span class="badge badge-info" id="similar-js-count">0 phần tử</span>
                    </div>
                    <div class="comparison-content" id="similarJs">
                        <div class="empty-state">
                            <div class="empty-state-icon">🔍</div>
                            <p>Chưa có dữ liệu. Vui lòng phân tích cả hai file.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="missing-tab">
                <div class="comparison-result">
                    <div class="comparison-header">
                        <div class="comparison-title">CSS Selectors thiếu trong File 2</div>
                        <span class="badge badge-danger" id="missing-css-2-count">0 phần tử</span>
                    </div>
                    <div class="comparison-content" id="missingCss2">
                        <div class="empty-state">
                            <div class="empty-state-icon">🔍</div>
                            <p>Chưa có dữ liệu. Vui lòng phân tích cả hai file.</p>
                        </div>
                    </div>
                </div>

                <div class="comparison-result">
                    <div class="comparison-header">
                        <div class="comparison-title">JavaScript Functions thiếu trong File 2</div>
                        <span class="badge badge-danger" id="missing-js-2-count">0 phần tử</span>
                    </div>
                    <div class="comparison-content" id="missingJs2">
                        <div class="empty-state">
                            <div class="empty-state-icon">🔍</div>
                            <p>Chưa có dữ liệu. Vui lòng phân tích cả hai file.</p>
                        </div>
                    </div>
                </div>

                <div class="comparison-result">
                    <div class="comparison-header">
                        <div class="comparison-title">CSS Selectors thiếu trong File 1</div>
                        <span class="badge badge-danger" id="missing-css-1-count">0 phần tử</span>
                    </div>
                    <div class="comparison-content" id="missingCss1">
                        <div class="empty-state">
                            <div class="empty-state-icon">🔍</div>
                            <p>Chưa có dữ liệu. Vui lòng phân tích cả hai file.</p>
                        </div>
                    </div>
                </div>

                <div class="comparison-result">
                    <div class="comparison-header">
                        <div class="comparison-title">JavaScript Functions thiếu trong File 1</div>
                        <span class="badge badge-danger" id="missing-js-1-count">0 phần tử</span>
                    </div>
                    <div class="comparison-content" id="missingJs1">
                        <div class="empty-state">
                            <div class="empty-state-icon">🔍</div>
                            <p>Chưa có dữ liệu. Vui lòng phân tích cả hai file.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="text-diff-tab">
                <div class="comparison-result">
                    <div class="comparison-header">
                        <div class="comparison-title">So sánh Text thông minh</div>
                        <div class="diff-info">
                            <span class="badge badge-success" id="text-added-count">+0</span>
                            <span class="badge badge-danger" id="text-removed-count">-0</span>
                            <span class="badge badge-warning" id="text-modified-count">~0</span>
                            <span class="badge badge-info" id="text-diff-count">Chưa so sánh</span>
                        </div>
                    </div>

                    <div class="diff-stats">
                        <div class="stat-item">
                            <div class="stat-dot added"></div>
                            <span>Thêm: <strong id="stat-added">0</strong> dòng</span>
                        </div>
                        <div class="stat-item">
                            <div class="stat-dot removed"></div>
                            <span>Xóa: <strong id="stat-removed">0</strong> dòng</span>
                        </div>
                        <div class="stat-item">
                            <div class="stat-dot modified"></div>
                            <span>Sửa: <strong id="stat-modified">0</strong> dòng</span>
                        </div>
                        <div class="stat-item">
                            <div class="stat-dot unchanged"></div>
                            <span>Giữ nguyên: <strong id="stat-unchanged">0</strong> dòng</span>
                        </div>
                    </div>

                    <div class="diff-toolbar">
                        <button class="toolbar-btn" onclick="toggleInlineDiff()">
                            <span id="inline-diff-icon">🔍</span>
                            <span id="inline-diff-text">Bật so sánh chi tiết</span>
                        </button>
                        <button class="toolbar-btn" onclick="toggleWordWrap()">
                            <span id="word-wrap-icon">↩️</span>
                            <span id="word-wrap-text">Bật word wrap</span>
                        </button>
                        <button class="toolbar-btn" onclick="enableInteractiveDiff()">
                            <span id="interactive-diff-icon">🔄</span>
                            <span id="interactive-diff-text">Bật Merge Interactive</span>
                        </button>
                        <button class="toolbar-btn" onclick="exportDiff()">
                            📄 Xuất kết quả
                        </button>
                    </div>

                    <div class="text-diff-container">
                        <div class="diff-side">
                            <div class="diff-side-header">
                                <span>File 1</span>
                                <span id="text-diff-info-1">0 dòng</span>
                            </div>
                            <div class="diff-content-wrapper">
                                <div class="diff-line-numbers" id="diff-line-numbers-1"></div>
                                <div class="diff-text" id="text-diff-1" onscroll="syncDiffScroll(1)">
                                    <div class="diff-line diff-unchanged">Chưa có nội dung</div>
                                </div>
                            </div>
                        </div>
                        <div class="diff-side">
                            <div class="diff-side-header">
                                <span>File 2</span>
                                <span id="text-diff-info-2">0 dòng</span>
                            </div>
                            <div class="diff-content-wrapper">
                                <div class="diff-line-numbers" id="diff-line-numbers-2"></div>
                                <div class="diff-text" id="text-diff-2" onscroll="syncDiffScroll(2)">
                                    <div class="diff-line diff-unchanged">Chưa có nội dung</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Biến toàn cục
        let analysisResults = {
            file1: { css: [], js: [], html: '', fileName: '', fileSize: 0, duplicates: { css: [], js: [] }, unused: { css: [], js: [] } },
            file2: { css: [], js: [], html: '', fileName: '', fileSize: 0, duplicates: { css: [], js: [] }, unused: { css: [], js: [] } },
            comparison: {
                duplicates: { css: [], js: [] },
                similar: { css: [], js: [] },
                missing: {
                    file1: { css: [], js: [] },
                    file2: { css: [], js: [] }
                }
            }
        };

        let inputModes = {
            file1: 'file',
            file2: 'file'
        };

        let diffSettings = {
            showInlineDiff: false,
            wordWrap: false,
            interactiveMode: false
        };

        // Biến để đồng bộ scroll
        let isScrolling = false;

        // Khởi tạo
        document.addEventListener('DOMContentLoaded', function () {
            setupDragAndDrop(1);
            setupDragAndDrop(2);
            updateLineCount(1);
            updateLineCount(2);
            showNotification('Chào mừng đến với Công cụ So sánh HTML/CSS/JS!', 'info', 3000);
        });

        // NEW: Hiển thị danh sách hàm có thể merge
        function displayMergeableFunctions() {
            const comp = analysisResults.comparison;
            const mergeListElement = document.getElementById('merge-functions-list');

            if (comp.similar.css.length === 0 && comp.similar.js.length === 0) {
                mergeListElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">✅</div>
                        <p>Không có hàm nào có thể merge. Tất cả các hàm đã giống nhau hoặc không có hàm trùng tên.</p>
                    </div>
                `;
                return;
            }

            let html = '';

            // Hiển thị CSS có thể merge
            comp.similar.css.forEach((css, index) => {
                html += createMergeFunctionItem(css, 'css', index);
            });

            // Hiển thị JS có thể merge
            comp.similar.js.forEach((js, index) => {
                html += createMergeFunctionItem(js, 'js', index + comp.similar.css.length);
            });

            mergeListElement.innerHTML = html;
        }

        // NEW: Tạo item merge function
        function createMergeFunctionItem(item, type, index) {
            const file1Code = type === 'css' ? item.full : item.fullCode;
            const file2Code = type === 'css' ? item.otherVersion.full : item.otherVersion.fullCode;

            return `
                <div class="merge-function-item">
                    <div class="merge-function-header">
                        <div>
                            <div class="merge-function-name">${item.name}</div>
                            <span class="merge-function-type">${type === 'css' ? 'CSS Selector' : 'JavaScript Function'}</span>
                        </div>
                        <div class="merge-function-actions">
                            <button class="btn-success" onclick="mergeFunction(${index}, '${type}', '1to2')">
                                📤 1→2
                            </button>
                            <button class="btn-success" onclick="mergeFunction(${index}, '${type}', '2to1')">
                                📥 2→1
                            </button>
                        </div>
                    </div>
                    
                    <div class="code-diff">
                        <div class="code-side">
                            <div class="code-side-header">File 1</div>
                            <div class="code-side-content"><pre><code class="language-${type}">${escapeHtml(file1Code)}</code></pre></div>
                        </div>
                        <div class="code-side">
                            <div class="code-side-header">File 2</div>
                            <div class="code-side-content"><pre><code class="language-${type}">${escapeHtml(file2Code)}</code></pre></div>
                        </div>
                    </div>
                    
                    <div class="merge-preview">
                        <div class="merge-preview-title">So sánh chi tiết:</div>
                        <div style="font-family: 'Consolas', monospace; font-size: 12px; line-height: 1.4;">
                            ${generateDetailedComparison(file1Code, file2Code)}
                        </div>
                    </div>
                </div>
            `;
        }

        // NEW: Tạo so sánh chi tiết
        function generateDetailedComparison(code1, code2) {
            const lines1 = code1.split('\n');
            const lines2 = code2.split('\n');
            let result = '';

            const maxLines = Math.max(lines1.length, lines2.length);

            for (let i = 0; i < maxLines; i++) {
                const line1 = lines1[i] || '';
                const line2 = lines2[i] || '';

                if (line1 === line2) {
                    result += `<div style="color: var(--vs-text-secondary);">${i + 1}: ${escapeHtml(line1)}</div>`;
                } else {
                    result += `<div style="color: var(--vs-yellow);">${i + 1}: ${escapeHtml(line1)}</div>`;
                    result += `<div style="color: var(--vs-yellow); margin-left: 20px;">→ ${escapeHtml(line2)}</div>`;
                }
            }

            return result;
        }

        // NEW: Merge function đơn lẻ
        function mergeFunction(index, type, direction) {
            const comp = analysisResults.comparison;
            let item;

            if (type === 'css') {
                if (index < comp.similar.css.length) {
                    item = comp.similar.css[index];
                } else {
                    return;
                }
            } else {
                const jsIndex = index - comp.similar.css.length;
                if (jsIndex < comp.similar.js.length) {
                    item = comp.similar.js[jsIndex];
                } else {
                    return;
                }
            }

            const sourceFile = direction === '1to2' ? 'file1' : 'file2';
            const targetFile = direction === '1to2' ? 'file2' : 'file1';
            const sourceCode = type === 'css' ? item.full : item.fullCode;
            const targetCode = type === 'css' ? item.otherVersion.full : item.otherVersion.fullCode;

            // Thực hiện merge
            performCodeMerge(sourceCode, targetCode, sourceFile, targetFile, type, item.name);

            showNotification(`Đã merge ${type === 'css' ? 'CSS selector' : 'JavaScript function'} "${item.name}" từ File ${sourceFile === 'file1' ? '1' : '2'} sang File ${targetFile === 'file1' ? '1' : '2'}`, 'success');

            // Làm mới phân tích
            setTimeout(() => {
                analyzeFile(sourceFile === 'file1' ? 1 : 2);
                analyzeFile(targetFile === 'file1' ? 1 : 2);
                compareFiles();
                displayMergeableFunctions();
            }, 500);
        }

        // NEW: Merge tất cả functions
        function mergeAllFunctions(direction) {
            const comp = analysisResults.comparison;
            let mergedCount = 0;

            // Merge CSS
            comp.similar.css.forEach(item => {
                const sourceCode = item.full;
                const targetCode = item.otherVersion.full;
                const sourceFile = direction === '1to2' ? 'file1' : 'file2';
                const targetFile = direction === '1to2' ? 'file2' : 'file1';

                performCodeMerge(sourceCode, targetCode, sourceFile, targetFile, 'css', item.name);
                mergedCount++;
            });

            // Merge JS
            comp.similar.js.forEach(item => {
                const sourceCode = item.fullCode;
                const targetCode = item.otherVersion.fullCode;
                const sourceFile = direction === '1to2' ? 'file1' : 'file2';
                const targetFile = direction === '1to2' ? 'file2' : 'file1';

                performCodeMerge(sourceCode, targetCode, sourceFile, targetFile, 'js', item.name);
                mergedCount++;
            });

            if (mergedCount > 0) {
                showNotification(`Đã merge ${mergedCount} hàm từ File ${direction === '1to2' ? '1' : '2'} sang File ${direction === '1to2' ? '2' : '1'}`, 'success');

                // Làm mới phân tích
                setTimeout(() => {
                    analyzeBothFiles();
                    compareFiles();
                    displayMergeableFunctions();
                }, 500);
            } else {
                showNotification('Không có hàm nào để merge', 'warning');
            }
        }

        // NEW: Thực hiện merge code
        function performCodeMerge(sourceCode, targetCode, sourceFile, targetFile, type, name) {
            const targetHtml = analysisResults[targetFile].html;

            // Tạo regex để tìm code cần thay thế
            let regex;
            if (type === 'css') {
                // Escape các ký tự đặc biệt trong CSS
                const escapedTargetCode = targetCode.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                regex = new RegExp(escapedTargetCode, 'g');
            } else {
                // Escape các ký tự đặc biệt trong JS
                const escapedTargetCode = targetCode.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                regex = new RegExp(escapedTargetCode, 'g');
            }

            // Thay thế code
            const newHtml = targetHtml.replace(regex, sourceCode);
            analysisResults[targetFile].html = newHtml;

            // Cập nhật hiển thị
            updateFileContent(targetFile === 'file1' ? 1 : 2);
        }

        // NEW: Tối ưu hóa file
        function optimizeFile(fileNum) {
            if (!analysisResults[`file${fileNum}`].html) {
                showNotification(`Vui lòng nhập nội dung cho File ${fileNum} trước khi tối ưu`, 'error');
                return;
            }

            const btn = document.getElementById(`optimize-btn-${fileNum}`);
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loading"></div> Đang tối ưu...';
            btn.disabled = true;

            setTimeout(() => {
                try {
                    // Phân tích code
                    analyzeFile(fileNum);

                    // Hiển thị kết quả tối ưu
                    displayOptimizationResults(fileNum);

                    showNotification(`Đã phân tích File ${fileNum} để tối ưu`, 'success');
                } catch (error) {
                    showNotification(`Lỗi khi tối ưu File ${fileNum}: ${error.message}`, 'error');
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }, 500);
        }

        // NEW: Hiển thị kết quả tối ưu
        function displayOptimizationResults(fileNum) {
            const fileData = analysisResults[`file${fileNum}`];

            // Hiển thị CSS không sử dụng
            const unusedCssElement = document.getElementById(`unused-css-${fileNum}`);
            if (fileData.unused.css.length > 0) {
                let html = '';
                fileData.unused.css.forEach(css => {
                    html += `
                        <div class="optimization-item">
                            <div class="optimization-item-info">
                                <div class="optimization-item-name">${css.name}</div>
                                <div class="optimization-item-desc">CSS selector không được sử dụng</div>
                            </div>
                            <div class="optimization-item-actions">
                                <button class="merge-btn" onclick="removeSpecificCSS(${fileNum}, '${css.name}')">
                                    🗑️ Xóa
                                </button>
                            </div>
                        </div>
                    `;
                });
                unusedCssElement.innerHTML = html;
            } else {
                unusedCssElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">✅</div>
                        <p>Không có CSS selectors không sử dụng</p>
                    </div>
                `;
            }

            // Hiển thị JS không sử dụng
            const unusedJsElement = document.getElementById(`unused-js-${fileNum}`);
            if (fileData.unused.js.length > 0) {
                let html = '';
                fileData.unused.js.forEach(js => {
                    html += `
                        <div class="optimization-item">
                            <div class="optimization-item-info">
                                <div class="optimization-item-name">${js.name}</div>
                                <div class="optimization-item-desc">JavaScript function không được sử dụng</div>
                            </div>
                            <div class="optimization-item-actions">
                                <button class="merge-btn" onclick="removeSpecificJS(${fileNum}, '${js.name}')">
                                    🗑️ Xóa
                                </button>
                            </div>
                        </div>
                    `;
                });
                unusedJsElement.innerHTML = html;
            } else {
                unusedJsElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">✅</div>
                        <p>Không có JavaScript functions không sử dụng</p>
                    </div>
                `;
            }

            // Hiển thị CSS trùng lặp
            const duplicateCssElement = document.getElementById(`duplicate-css-${fileNum}`);
            if (fileData.duplicates.css.length > 0) {
                let html = '';
                fileData.duplicates.css.forEach(css => {
                    html += `
                        <div class="optimization-item">
                            <div class="optimization-item-info">
                                <div class="optimization-item-name">${css.name}</div>
                                <div class="optimization-item-desc">CSS selector bị trùng lặp</div>
                            </div>
                            <div class="optimization-item-actions">
                                <button class="merge-btn" onclick="removeSpecificCSS(${fileNum}, '${css.name}')">
                                    🗑️ Xóa
                                </button>
                            </div>
                        </div>
                    `;
                });
                duplicateCssElement.innerHTML = html;
            } else {
                duplicateCssElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">✅</div>
                        <p>Không có CSS selectors trùng lặp</p>
                    </div>
                `;
            }

            // Cập nhật số lượng
            document.getElementById(`optimization-${fileNum}-count`).textContent =
                `${fileData.unused.css.length + fileData.unused.js.length + fileData.duplicates.css.length} vấn đề`;
        }

        // NEW: Xóa CSS không sử dụng
        function removeUnusedCSS(fileNum) {
            const fileData = analysisResults[`file${fileNum}`];
            let html = fileData.html;

            fileData.unused.css.forEach(css => {
                // Xóa CSS selector khỏi HTML
                const regex = new RegExp(`${escapeRegExp(css.full)}\\s*`, 'g');
                html = html.replace(regex, '');
            });

            // Cập nhật nội dung
            fileData.html = html;
            updateFileContent(fileNum);

            // Làm mới phân tích
            analyzeFile(fileNum);
            displayOptimizationResults(fileNum);

            showNotification(`Đã xóa ${fileData.unused.css.length} CSS selectors không sử dụng`, 'success');
        }

        // NEW: Xóa JS không sử dụng
        function removeUnusedJS(fileNum) {
            const fileData = analysisResults[`file${fileNum}`];
            let html = fileData.html;

            fileData.unused.js.forEach(js => {
                // Xóa JS function khỏi HTML
                const regex = new RegExp(`${escapeRegExp(js.fullCode)}\\s*`, 'g');
                html = html.replace(regex, '');
            });

            // Cập nhật nội dung
            fileData.html = html;
            updateFileContent(fileNum);

            // Làm mới phân tích
            analyzeFile(fileNum);
            displayOptimizationResults(fileNum);

            showNotification(`Đã xóa ${fileData.unused.js.length} JavaScript functions không sử dụng`, 'success');
        }

        // NEW: Xóa CSS trùng lặp
        function removeDuplicateCSS(fileNum) {
            const fileData = analysisResults[`file${fileNum}`];
            let html = fileData.html;

            fileData.duplicates.css.forEach(css => {
                // Xóa CSS selector trùng lặp khỏi HTML
                const regex = new RegExp(`${escapeRegExp(css.full)}\\s*`, 'g');
                // Chỉ giữ lại lần xuất hiện đầu tiên
                html = html.replace(regex, (match, offset) => {
                    return offset === html.indexOf(match) ? match : '';
                });
            });

            // Cập nhật nội dung
            fileData.html = html;
            updateFileContent(fileNum);

            // Làm mới phân tích
            analyzeFile(fileNum);
            displayOptimizationResults(fileNum);

            showNotification(`Đã xóa ${fileData.duplicates.css.length} CSS selectors trùng lặp`, 'success');
        }

        // NEW: Xóa CSS cụ thể
        function removeSpecificCSS(fileNum, cssName) {
            const fileData = analysisResults[`file${fileNum}`];
            let html = fileData.html;

            const cssToRemove = fileData.unused.css.find(css => css.name === cssName) ||
                fileData.duplicates.css.find(css => css.name === cssName);

            if (cssToRemove) {
                const regex = new RegExp(`${escapeRegExp(cssToRemove.full)}\\s*`, 'g');
                html = html.replace(regex, '');

                // Cập nhật nội dung
                fileData.html = html;
                updateFileContent(fileNum);

                // Làm mới phân tích
                analyzeFile(fileNum);
                displayOptimizationResults(fileNum);

                showNotification(`Đã xóa CSS selector: ${cssName}`, 'success');
            }
        }

        // NEW: Xóa JS cụ thể
        function removeSpecificJS(fileNum, jsName) {
            const fileData = analysisResults[`file${fileNum}`];
            let html = fileData.html;

            const jsToRemove = fileData.unused.js.find(js => js.name === jsName);

            if (jsToRemove) {
                const regex = new RegExp(`${escapeRegExp(jsToRemove.fullCode)}\\s*`, 'g');
                html = html.replace(regex, '');

                // Cập nhật nội dung
                fileData.html = html;
                updateFileContent(fileNum);

                // Làm mới phân tích
                analyzeFile(fileNum);
                displayOptimizationResults(fileNum);

                showNotification(`Đã xóa JavaScript function: ${jsName}`, 'success');
            }
        }

        // NEW: Lưu thay đổi
        function saveChanges(fileNum) {
            const fileData = analysisResults[`file${fileNum}`];
            if (!fileData.html) {
                showNotification(`Không có nội dung để lưu cho File ${fileNum}`, 'error');
                return;
            }

            const blob = new Blob([fileData.html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileData.fileName || `optimized-file-${fileNum}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification(`Đã lưu File ${fileNum}`, 'success');
        }

        // NEW: Bật chế độ interactive diff
        function enableInteractiveDiff() {
            diffSettings.interactiveMode = !diffSettings.interactiveMode;
            document.getElementById('interactive-diff-icon').textContent =
                diffSettings.interactiveMode ? '🔄✅' : '🔄';
            document.getElementById('interactive-diff-text').textContent =
                diffSettings.interactiveMode ? 'Tắt Merge Interactive' : 'Bật Merge Interactive';

            updateTextDiffView();
        }

        // NEW: Escape regex
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // NEW: So sánh file chi tiết
        function displayFileComparison() {
            const comp = analysisResults.comparison;
            const f1 = analysisResults.file1;
            const f2 = analysisResults.file2;

            // Hiển thị so sánh CSS
            const cssComparisonElement = document.getElementById('css-comparison-details');
            let cssHtml = '';

            // Tìm tất cả CSS selectors duy nhất từ cả hai file
            const allCss = [...new Set([...f1.css.map(c => c.name), ...f2.css.map(c => c.name)])];

            allCss.forEach(cssName => {
                const css1 = f1.css.find(c => c.name === cssName);
                const css2 = f2.css.find(c => c.name === cssName);

                let status = '';
                let statusClass = '';

                if (css1 && css2) {
                    if (normalizeCode(css1.full) === normalizeCode(css2.full)) {
                        status = 'Có trong cả hai';
                        statusClass = 'status-present';
                    } else {
                        status = 'Khác nhau';
                        statusClass = 'status-different';
                    }
                } else if (css1) {
                    status = 'Chỉ có trong File 1';
                    statusClass = 'status-missing';
                } else {
                    status = 'Chỉ có trong File 2';
                    statusClass = 'status-missing';
                }

                cssHtml += `
                    <div class="comparison-item">
                        <div class="comparison-item-name">${cssName}</div>
                        <span class="comparison-item-status ${statusClass}">${status}</span>
                    </div>
                `;
            });

            cssComparisonElement.innerHTML = cssHtml || `
                <div class="empty-state">
                    <div class="empty-state-icon">🔍</div>
                    <p>Không có CSS selectors để so sánh</p>
                </div>
            `;

            // Hiển thị so sánh JS
            const jsComparisonElement = document.getElementById('js-comparison-details');
            let jsHtml = '';

            // Tìm tất cả JS functions duy nhất từ cả hai file
            const allJs = [...new Set([...f1.js.map(j => j.name), ...f2.js.map(j => j.name)])];

            allJs.forEach(jsName => {
                const js1 = f1.js.find(j => j.name === jsName);
                const js2 = f2.js.find(j => j.name === jsName);

                let status = '';
                let statusClass = '';

                if (js1 && js2) {
                    if (normalizeCode(js1.fullCode) === normalizeCode(js2.fullCode)) {
                        status = 'Có trong cả hai';
                        statusClass = 'status-present';
                    } else {
                        status = 'Khác nhau';
                        statusClass = 'status-different';
                    }
                } else if (js1) {
                    status = 'Chỉ có trong File 1';
                    statusClass = 'status-missing';
                } else {
                    status = 'Chỉ có trong File 2';
                    statusClass = 'status-missing';
                }

                jsHtml += `
                    <div class="comparison-item">
                        <div class="comparison-item-name">${jsName}</div>
                        <span class="comparison-item-status ${statusClass}">${status}</span>
                    </div>
                `;
            });

            jsComparisonElement.innerHTML = jsHtml || `
                <div class="empty-state">
                    <div class="empty-state-icon">🔍</div>
                    <p>Không có JavaScript functions để so sánh</p>
                </div>
            `;

            // Cập nhật số lượng
            document.getElementById('comparison-css-count').textContent = `${allCss.length} CSS selectors`;
            document.getElementById('comparison-js-count').textContent = `${allJs.length} JS functions`;

            // Hiển thị tổng quan
            const overallElement = document.getElementById('overall-comparison');
            const totalItems = allCss.length + allJs.length;
            const identicalItems = comp.duplicates.css.length + comp.duplicates.js.length;
            const differentItems = comp.similar.css.length + comp.similar.js.length;
            const missingItems = (comp.missing.file1.css.length + comp.missing.file1.js.length +
                comp.missing.file2.css.length + comp.missing.file2.js.length);

            const similarityPercent = totalItems > 0 ? (identicalItems / totalItems * 100).toFixed(1) : 0;

            overallElement.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div style="text-align: center; padding: 10px; background: var(--vs-sidebar); border-radius: 4px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--vs-green);">${similarityPercent}%</div>
                        <div style="font-size: 0.8rem; color: var(--vs-text-secondary);">Độ tương đồng</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: var(--vs-sidebar); border-radius: 4px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--vs-blue);">${totalItems}</div>
                        <div style="font-size: 0.8rem; color: var(--vs-text-secondary);">Tổng phần tử</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--vs-green);">${identicalItems}</div>
                        <div style="font-size: 0.7rem; color: var(--vs-text-secondary);">Giống nhau</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--vs-yellow);">${differentItems}</div>
                        <div style="font-size: 0.7rem; color: var(--vs-text-secondary);">Khác nhau</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--vs-red);">${missingItems}</div>
                        <div style="font-size: 0.7rem; color: var(--vs-text-secondary);">Thiếu</div>
                    </div>
                </div>
            `;

            document.getElementById('overall-comparison-count').textContent = `${totalItems} phần tử`;
        }

        // Các hàm hiện có giữ nguyên...
        // Đồng bộ scroll line numbers
        function syncScroll(fileNum) {
            const textarea = document.getElementById(`file-content-text-${fileNum}`);
            const lineNumbers = document.getElementById(`line-numbers-${fileNum}`);
            if (textarea && lineNumbers) {
                lineNumbers.scrollTop = textarea.scrollTop;
            }
        }

        // Đồng bộ scroll giữa hai khung diff
        function syncDiffScroll(source) {
            if (isScrolling) return;

            isScrolling = true;

            const sourceElement = document.getElementById(`text-diff-${source}`);
            const targetElement = document.getElementById(`text-diff-${source === '1' ? '2' : '1'}`);

            if (sourceElement && targetElement) {
                targetElement.scrollTop = sourceElement.scrollTop;
                targetElement.scrollLeft = sourceElement.scrollLeft;
            }

            // Đồng bộ line numbers
            const sourceLineNumbers = document.getElementById(`diff-line-numbers-${source}`);
            const targetLineNumbers = document.getElementById(`diff-line-numbers-${source === '1' ? '2' : '1'}`);

            if (sourceLineNumbers && targetLineNumbers) {
                targetLineNumbers.scrollTop = sourceLineNumbers.scrollTop;
            }

            setTimeout(() => {
                isScrolling = false;
            }, 50);
        }

        // Chuyển đổi chế độ nhập
        function switchInputMode(fileNum, mode) {
            inputModes[`file${fileNum}`] = mode;

            // Cập nhật UI
            document.getElementById(`mode-file${fileNum}-file`).classList.toggle('active', mode === 'file');
            document.getElementById(`mode-file${fileNum}-text`).classList.toggle('active', mode === 'text');
            document.getElementById(`upload-area-${fileNum}`).style.display = mode === 'file' ? 'block' : 'none';
            document.getElementById(`text-input-${fileNum}`).style.display = mode === 'text' ? 'flex' : 'none';
            document.getElementById(`preview-container-${fileNum}`).style.display = mode === 'file' ? 'flex' : 'none';

            // Cập nhật nội dung
            updateFileContent(fileNum);
        }

        // Cập nhật nội dung file
        function updateFileContent(fileNum) {
            const mode = inputModes[`file${fileNum}`];
            let content = '';

            if (mode === 'text') {
                content = document.getElementById(`file-content-text-${fileNum}`).value;
            } else {
                content = analysisResults[`file${fileNum}`].html;
                // Hiển thị nội dung file trong preview với highlight
                if (content) {
                    const previewElement = document.querySelector(`#file-content-preview-${fileNum} code`);
                    previewElement.textContent = content;
                    hljs.highlightElement(previewElement);
                    updatePreviewLineCount(fileNum);
                }
            }

            analysisResults[`file${fileNum}`].html = content;

            // Cập nhật text diff view
            updateTextDiffView();

            // Cập nhật trạng thái
            const hasContent = content.trim().length > 0;
            document.getElementById(`file${fileNum}-stats`).textContent = hasContent ? 'Đã có nội dung' : 'Chưa có nội dung';
            document.getElementById(`file${fileNum}-stats`).className = hasContent ? 'badge badge-success' : 'badge badge-info';

            if (mode === 'text' && hasContent) {
                document.getElementById(`file-info-${fileNum}`).innerHTML = `<strong>Chế độ:</strong> Nhập code trực tiếp`;
            } else if (mode === 'file' && hasContent) {
                document.getElementById(`file-info-${fileNum}`).innerHTML =
                    `<strong>File:</strong> ${analysisResults[`file${fileNum}`].fileName || 'Chưa xác định'} | <strong>Kích thước:</strong> ${(analysisResults[`file${fileNum}`].fileSize / 1024).toFixed(2)} KB`;
            }
        }

        // Cập nhật số dòng cho preview
        function updatePreviewLineCount(fileNum) {
            const content = analysisResults[`file${fileNum}`].html || '';
            const lineCount = content.split('\n').length;

            // Cập nhật số dòng hiển thị
            document.getElementById(`preview${fileNum}-lines`).textContent = `${lineCount} dòng`;

            // Cập nhật line numbers
            let lineNumbersHTML = '';
            for (let i = 1; i <= lineCount; i++) {
                lineNumbersHTML += i + '<br>';
            }
            document.getElementById(`preview-line-numbers-${fileNum}`).innerHTML = lineNumbersHTML;
        }

        // Cập nhật số dòng cho textarea
        function updateLineCount(fileNum) {
            const textarea = document.getElementById(`file-content-text-${fileNum}`);
            if (!textarea) return;

            const content = textarea.value;
            const lineCount = content.split('\n').length;

            // Cập nhật số dòng hiển thị
            document.getElementById(`file${fileNum}-lines`).textContent = `${lineCount} dòng`;

            // Cập nhật line numbers
            let lineNumbersHTML = '';
            for (let i = 1; i <= lineCount; i++) {
                lineNumbersHTML += i + '<br>';
            }
            document.getElementById(`line-numbers-${fileNum}`).innerHTML = lineNumbersHTML;

            updateFileContent(fileNum);
        }

        // Thiết lập drag & drop
        function setupDragAndDrop(fileNum) {
            const uploadArea = document.getElementById(`upload-area-${fileNum}`);

            uploadArea.addEventListener('dragover', function (e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function () {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function (e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(fileNum, files[0]);
                }
            });
        }

        // Xử lý chọn file
        function handleFileSelect(fileNum, file) {
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.html') && !file.name.toLowerCase().endsWith('.htm')) {
                showNotification('Vui lòng chọn file HTML (.html hoặc .htm)', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const content = e.target.result;
                analysisResults[`file${fileNum}`].html = content;
                analysisResults[`file${fileNum}`].fileName = file.name;
                analysisResults[`file${fileNum}`].fileSize = file.size;

                // HIỂN THỊ NỘI DUNG FILE: Cập nhật preview với highlight
                const previewElement = document.querySelector(`#file-content-preview-${fileNum} code`);
                previewElement.textContent = content;
                hljs.highlightElement(previewElement);
                updatePreviewLineCount(fileNum);

                // Cũng cập nhật textarea để đồng bộ
                document.getElementById(`file-content-text-${fileNum}`).value = content;
                updateLineCount(fileNum);

                // Hiển thị thông tin file
                const fileSizeKB = (file.size / 1024).toFixed(2);
                document.getElementById(`file-info-${fileNum}`).innerHTML =
                    `<strong>File:</strong> ${file.name} | <strong>Kích thước:</strong> ${fileSizeKB} KB`;

                document.getElementById(`file${fileNum}-stats`).textContent = 'Đã tải';
                document.getElementById(`file${fileNum}-stats`).className = 'badge badge-success';

                showNotification(`Đã tải file ${file.name}`, 'success');
            };
            reader.readAsText(file);
            updatePreviewLineNumbers(fileNum);
        }

        function updatePreviewLineNumbers(fileNum) {
            const codeElement = document.querySelector(`#file-content-preview-${fileNum} code`);
            const lines = codeElement.innerText.split('\n').length;
            const lineNumbersElement = document.getElementById(`preview-line-numbers-${fileNum}`);
            lineNumbersElement.innerHTML = Array.from({ length: lines }, (_, i) => i + 1).join('\n');
        }

        function syncPreviewScroll(fileNum) {
            const content = document.getElementById(`file-content-preview-${fileNum}`);
            const lines = document.getElementById(`preview-line-numbers-${fileNum}`);
            lines.scrollTop = content.scrollTop;
        }


        // Hiển thị thông báo
        function showNotification(message, type = 'info', duration = 4000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, duration);
        }

        // Chuyển đổi tab
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Tìm tab tương ứng
            const tabs = document.querySelectorAll('.tab');
            for (let i = 0; i < tabs.length; i++) {
                if (tabs[i].textContent.includes(getTabDisplayName(tabName))) {
                    tabs[i].classList.add('active');
                    break;
                }
            }

            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Nếu là tab text diff, cập nhật nội dung
            if (tabName === 'text-diff') {
                updateTextDiffView();
            }

            // Nếu là tab file comparison, hiển thị so sánh
            if (tabName === 'file-comparison') {
                displayFileComparison();
            }

            // Nếu là tab merge functions, hiển thị hàm có thể merge
            if (tabName === 'merge-functions') {
                displayMergeableFunctions();
            }
        }

        function getTabDisplayName(tabName) {
            const tabMap = {
                'analysis': 'Phân tích từng File',
                'optimization': 'Tối ưu hóa',
                'file-comparison': 'So sánh File',
                'merge-functions': 'Merge Hàm',
                'duplicates': 'Trùng lặp',
                'similar': 'Tương tự',
                'missing': 'Thiếu & Thừa',
                'text-diff': 'So sánh Text'
            };
            return tabMap[tabName] || tabName;
        }

        // [Các hàm còn lại giữ nguyên từ code trước]
        // computeSmartDiff, computeLCSDiff, normalizeLine, computeInlineDiff, 
        // diffChars, updateTextDiffView, updateDiffSide, mergeLine, toggleInlineDiff, 
        // toggleWordWrap, exportDiff, escapeHtml, extractCSS, extractJS,
        // findFunctionDeclarations, findFunctionExpressions, findArrowFunctions,
        // analyzeUnusedCode, isCSSUsed, isJSUsed, findDuplicatesInFile,
        // analyzeFile, displayFileAnalysis, analyzeBothFiles, compareFiles,
        // performComparison, findExactDuplicates, findSimilarButDifferent,
        // findMissing, normalizeCode, displayComparisonResults, displaySimilarItems,
        // displayMissingItems, clearFile, clearBothFiles

        // THUẬT TOÁN SO SÁNH TEXT THÔNG MINH - CẢI TIẾN
        function computeSmartDiff(text1, text2) {
            const lines1 = text1.split('\n');
            const lines2 = text2.split('\n');

            // Sử dụng thuật toán LCS (Longest Common Subsequence) để tìm sự khác biệt
            const diff = computeLCSDiff(lines1, lines2);

            let added = 0, removed = 0, modified = 0, unchanged = 0;

            const result1 = [];
            const result2 = [];

            diff.forEach(change => {
                if (change.type === 'equal') {
                    unchanged += change.count;
                    for (let i = 0; i < change.count; i++) {
                        const idx = change.oldStart + i;
                        result1.push({
                            text: lines1[idx],
                            type: 'unchanged',
                            lineNumber: idx + 1
                        });
                        result2.push({
                            text: lines2[change.newStart + i],
                            type: 'unchanged',
                            lineNumber: change.newStart + i + 1
                        });
                    }
                } else if (change.type === 'delete') {
                    removed += change.count;
                    for (let i = 0; i < change.count; i++) {
                        result1.push({
                            text: lines1[change.oldStart + i],
                            type: 'removed',
                            lineNumber: change.oldStart + i + 1
                        });
                        result2.push({
                            text: '',
                            type: 'empty',
                            lineNumber: null
                        });
                    }
                } else if (change.type === 'insert') {
                    added += change.count;
                    for (let i = 0; i < change.count; i++) {
                        result1.push({
                            text: '',
                            type: 'empty',
                            lineNumber: null
                        });
                        result2.push({
                            text: lines2[change.newStart + i],
                            type: 'added',
                            lineNumber: change.newStart + i + 1
                        });
                    }
                } else if (change.type === 'replace') {
                    modified += Math.min(change.oldCount, change.newCount);
                    const maxCount = Math.max(change.oldCount, change.newCount);
                    for (let i = 0; i < maxCount; i++) {
                        if (i < change.oldCount) {
                            result1.push({
                                text: lines1[change.oldStart + i],
                                type: i < change.newCount ? 'modified' : 'removed',
                                lineNumber: change.oldStart + i + 1
                            });
                        } else {
                            result1.push({
                                text: '',
                                type: 'empty',
                                lineNumber: null
                            });
                        }

                        if (i < change.newCount) {
                            result2.push({
                                text: lines2[change.newStart + i],
                                type: i < change.oldCount ? 'modified' : 'added',
                                lineNumber: change.newStart + i + 1
                            });
                        } else {
                            result2.push({
                                text: '',
                                type: 'empty',
                                lineNumber: null
                            });
                        }
                    }
                }
            });

            return {
                result1,
                result2,
                added,
                removed,
                modified,
                unchanged,
                similarity: unchanged / Math.max(lines1.length, lines2.length)
            };
        }

        // Thuật toán LCS (Longest Common Subsequence) để tìm sự khác biệt
        function computeLCSDiff(a, b) {
            const m = a.length;
            const n = b.length;

            // Tạo ma trận LCS
            const dp = Array(m + 1).fill().map(() => Array(n + 1).fill(0));

            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    if (normalizeLine(a[i - 1]) === normalizeLine(b[j - 1])) {
                        dp[i][j] = dp[i - 1][j - 1] + 1;
                    } else {
                        dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
                    }
                }
            }

            // Truy vết để tìm sự khác biệt
            const changes = [];
            let i = m, j = n;

            while (i > 0 || j > 0) {
                if (i > 0 && j > 0 && normalizeLine(a[i - 1]) === normalizeLine(b[j - 1])) {
                    // Dòng giống nhau
                    if (changes.length > 0 && changes[0].type === 'equal') {
                        changes[0].count++;
                        changes[0].oldStart--;
                        changes[0].newStart--;
                    } else {
                        changes.unshift({
                            type: 'equal',
                            oldStart: i - 1,
                            newStart: j - 1,
                            count: 1
                        });
                    }
                    i--;
                    j--;
                } else if (j > 0 && (i === 0 || dp[i][j - 1] >= dp[i - 1][j])) {
                    // Dòng được thêm vào
                    if (changes.length > 0 && changes[0].type === 'insert') {
                        changes[0].count++;
                        changes[0].newStart--;
                    } else {
                        changes.unshift({
                            type: 'insert',
                            oldStart: i,
                            newStart: j - 1,
                            count: 1
                        });
                    }
                    j--;
                } else if (i > 0 && (j === 0 || dp[i][j - 1] < dp[i - 1][j])) {
                    // Dòng bị xóa
                    if (changes.length > 0 && changes[0].type === 'delete') {
                        changes[0].count++;
                        changes[0].oldStart--;
                    } else {
                        changes.unshift({
                            type: 'delete',
                            oldStart: i - 1,
                            newStart: j,
                            count: 1
                        });
                    }
                    i--;
                }
            }

            return changes;
        }

        // Chuẩn hóa dòng để so sánh (loại bỏ khoảng trắng thừa)
        function normalizeLine(line) {
            return line ? line.trim().replace(/\s+/g, ' ') : '';
        }

        // So sánh chi tiết từng dòng
        function computeInlineDiff(line1, line2) {
            if (line1 === line2) {
                return { text: escapeHtml(line1), type: 'unchanged' };
            }

            // Thuật toán so sánh từng ký tự
            const diff = diffChars(line1, line2);
            let result = '';

            diff.forEach(part => {
                if (part.added) {
                    result += `<span class="inline-added">${escapeHtml(part.value)}</span>`;
                } else if (part.removed) {
                    result += `<span class="inline-removed">${escapeHtml(part.value)}</span>`;
                } else {
                    result += escapeHtml(part.value);
                }
            });

            return { text: result, type: 'modified' };
        }

        // Thuật toán so sánh ký tự
        function diffChars(oldStr, newStr) {
            const diffs = [];
            let i = 0, j = 0;

            while (i < oldStr.length || j < newStr.length) {
                if (i < oldStr.length && j < newStr.length && oldStr[i] === newStr[j]) {
                    // Ký tự giống nhau
                    let count = 0;
                    while (i + count < oldStr.length && j + count < newStr.length &&
                        oldStr[i + count] === newStr[j + count]) {
                        count++;
                    }

                    diffs.push({
                        value: oldStr.substring(i, i + count),
                        added: false,
                        removed: false
                    });

                    i += count;
                    j += count;
                } else {
                    // Tìm đoạn khác biệt dài nhất
                    let deleteCount = 0;
                    let addCount = 0;

                    // Thử xóa từ vị trí hiện tại
                    while (i + deleteCount < oldStr.length &&
                        (j + addCount >= newStr.length || oldStr[i + deleteCount] !== newStr[j + addCount])) {
                        deleteCount++;
                    }

                    // Thử thêm từ vị trí hiện tại
                    while (j + addCount < newStr.length &&
                        (i + deleteCount >= oldStr.length || oldStr[i + deleteCount] !== newStr[j + addCount])) {
                        addCount++;
                    }

                    if (deleteCount > 0) {
                        diffs.push({
                            value: oldStr.substring(i, i + deleteCount),
                            removed: true,
                            added: false
                        });
                        i += deleteCount;
                    }

                    if (addCount > 0) {
                        diffs.push({
                            value: newStr.substring(j, j + addCount),
                            added: true,
                            removed: false
                        });
                        j += addCount;
                    }
                }
            }

            return diffs;
        }

        // Cập nhật text diff view với thuật toán thông minh
        function updateTextDiffView() {
            const text1 = analysisResults.file1.html || '';
            const text2 = analysisResults.file2.html || '';

            const diff = computeSmartDiff(text1, text2);

            // Cập nhật kết quả diff
            updateDiffSide('1', diff.result1, text1);
            updateDiffSide('2', diff.result2, text2);

            // Cập nhật thống kê
            document.getElementById('text-added-count').textContent = `+${diff.added}`;
            document.getElementById('text-removed-count').textContent = `-${diff.removed}`;
            document.getElementById('text-modified-count').textContent = `~${diff.modified}`;

            document.getElementById('stat-added').textContent = diff.added;
            document.getElementById('stat-removed').textContent = diff.removed;
            document.getElementById('stat-modified').textContent = diff.modified;
            document.getElementById('stat-unchanged').textContent = diff.unchanged;

            const hasContent1 = text1.trim().length > 0;
            const hasContent2 = text2.trim().length > 0;

            if (hasContent1 && hasContent2) {
                const similarityPercent = (diff.similarity * 100).toFixed(1);
                document.getElementById('text-diff-count').textContent = `Độ tương đồng: ${similarityPercent}%`;
                document.getElementById('text-diff-count').className = 'badge badge-info';
            } else {
                document.getElementById('text-diff-count').textContent = 'Chưa so sánh';
                document.getElementById('text-diff-count').className = 'badge badge-info';
            }
        }

        // Cập nhật một bên diff - ĐÃ SỬA: Xử lý giá trị undefined
        function updateDiffSide(sideNum, diffResult, originalText) {
            const diffTextElement = document.getElementById(`text-diff-${sideNum}`);
            const lineNumbersElement = document.getElementById(`diff-line-numbers-${sideNum}`);
            const infoElement = document.getElementById(`text-diff-info-${sideNum}`);

            let diffHTML = '';
            let lineNumbersHTML = '';
            let lineCount = 0;

            diffResult.forEach((line, index) => {
                lineCount++;
                const lineClass = `diff-${line.type}`;
                const interactiveClass = diffSettings.interactiveMode && (line.type === 'added' || line.type === 'removed' || line.type === 'modified') ? 'interactive' : '';

                // SỬA: Kiểm tra line.text có tồn tại không
                let lineContent = escapeHtml(line.text || '');

                // Xử lý so sánh chi tiết nếu được bật
                if (diffSettings.showInlineDiff && line.type === 'modified') {
                    const otherSideNum = sideNum === '1' ? '2' : '1';
                    const otherLine = sideNum === '1' ?
                        analysisResults.diffResult2[index] : analysisResults.diffResult1[index];

                    if (otherLine && otherLine.text) {
                        const inlineDiff = sideNum === '1' ?
                            computeInlineDiff(line.text || '', otherLine.text || '') :
                            computeInlineDiff(otherLine.text || '', line.text || '');
                        lineContent = inlineDiff.text;
                    }
                }

                // Thêm merge controls nếu ở chế độ interactive
                let mergeControls = '';
                if (diffSettings.interactiveMode && (line.type === 'added' || line.type === 'removed' || line.type === 'modified')) {
                    const mergeDirection = sideNum === '1' ? 'right' : 'left';
                    mergeControls = `
                        <div class="merge-controls">
                            <button class="merge-control-btn" onclick="mergeLine(${index}, '${mergeDirection}')">
                                ${mergeDirection === 'right' ? '→' : '←'}
                            </button>
                        </div>
                    `;
                }

                diffHTML += `<div class="diff-line ${lineClass} ${interactiveClass}" data-index="${index}" data-type="${line.type}">
                    ${lineContent}
                    ${mergeControls}
                </div>`;
                lineNumbersHTML += `<div class="diff-line ${lineClass}">${line.lineNumber || ''}</div>`;
            });

            diffTextElement.innerHTML = diffHTML;
            lineNumbersElement.innerHTML = lineNumbersHTML;

            // Áp dụng word wrap nếu được bật
            if (diffSettings.wordWrap) {
                diffTextElement.style.whiteSpace = 'pre-wrap';
            } else {
                diffTextElement.style.whiteSpace = 'pre';
            }

            const originalLineCount = originalText.split('\n').length;
            infoElement.textContent = `${lineCount} dòng (gốc: ${originalLineCount})`;

            // Lưu kết quả diff để sử dụng cho inline diff
            if (sideNum === '1') {
                analysisResults.diffResult1 = diffResult;
            } else {
                analysisResults.diffResult2 = diffResult;
            }
        }

        // NEW: Merge line từ file này sang file kia
        function mergeLine(lineIndex, direction) {
            const sourceFile = direction === 'right' ? 'file1' : 'file2';
            const targetFile = direction === 'right' ? 'file2' : 'file1';
            const sourceDiff = direction === 'right' ? analysisResults.diffResult1 : analysisResults.diffResult2;
            const targetDiff = direction === 'right' ? analysisResults.diffResult2 : analysisResults.diffResult1;

            const lineToMerge = sourceDiff[lineIndex];

            if (lineToMerge && lineToMerge.text) {
                // Tạo nội dung mới cho target file
                let newContent = '';
                targetDiff.forEach((line, idx) => {
                    if (idx === lineIndex) {
                        // Thay thế dòng hiện tại bằng dòng từ source
                        newContent += lineToMerge.text + '\n';
                    } else {
                        newContent += (line.text || '') + '\n';
                    }
                });

                // Cập nhật nội dung file đích
                analysisResults[targetFile].html = newContent.trim();
                updateFileContent(targetFile === 'file1' ? 1 : 2);

                showNotification(`Đã merge dòng từ File ${sourceFile === 'file1' ? 1 : 2} sang File ${targetFile === 'file1' ? 1 : 2}`, 'success');
            }
        }

        // Toggle inline diff
        function toggleInlineDiff() {
            diffSettings.showInlineDiff = !diffSettings.showInlineDiff;
            document.getElementById('inline-diff-icon').textContent = diffSettings.showInlineDiff ? '🔍✅' : '🔍';
            document.getElementById('inline-diff-text').textContent = diffSettings.showInlineDiff ? 'Tắt so sánh chi tiết' : 'Bật so sánh chi tiết';
            updateTextDiffView();
        }

        // Toggle word wrap
        function toggleWordWrap() {
            diffSettings.wordWrap = !diffSettings.wordWrap;
            document.getElementById('word-wrap-icon').textContent = diffSettings.wordWrap ? '↩️✅' : '↩️';
            document.getElementById('word-wrap-text').textContent = diffSettings.wordWrap ? 'Tắt word wrap' : 'Bật word wrap';
            updateTextDiffView();
        }

        // Xuất kết quả diff
        function exportDiff() {
            const text1 = analysisResults.file1.html || '';
            const text2 = analysisResults.file2.html || '';

            if (!text1 && !text2) {
                showNotification('Không có nội dung để xuất', 'error');
                return;
            }

            const diff = computeSmartDiff(text1, text2);
            let exportContent = `KẾT QUẢ SO SÁNH\n`;
            exportContent += `File 1: ${analysisResults.file1.fileName || 'Nội dung nhập tay'}\n`;
            exportContent += `File 2: ${analysisResults.file2.fileName || 'Nội dung nhập tay'}\n`;
            exportContent += `Thống kê: +${diff.added} thêm, -${diff.removed} xóa, ~${diff.modified} sửa, ${diff.unchanged} giữ nguyên\n`;
            exportContent += `Độ tương đồng: ${(diff.similarity * 100).toFixed(1)}%\n\n`;

            exportContent += `=== FILE 1 ===\n`;
            diff.result1.forEach(line => {
                const prefix = line.type === 'added' ? '+' : line.type === 'removed' ? '-' : line.type === 'modified' ? '~' : ' ';
                exportContent += `${prefix} ${line.text}\n`;
            });

            exportContent += `\n=== FILE 2 ===\n`;
            diff.result2.forEach(line => {
                const prefix = line.type === 'added' ? '+' : line.type === 'removed' ? '-' : line.type === 'modified' ? '~' : ' ';
                exportContent += `${prefix} ${line.text}\n`;
            });

            const blob = new Blob([exportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ket-qua-so-sanh.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('Đã xuất kết quả so sánh', 'success');
        }

        // SỬA: Hàm escapeHtml xử lý giá trị undefined/null
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) {
                return '';
            }
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Các hàm phân tích code
        function extractCSS(html) {
            const css = [];
            const styleRegex = /<style[^>]*>([\s\S]*?)<\/style>/gi;
            let match;

            while ((match = styleRegex.exec(html)) !== null) {
                const styleContent = match[1];
                const cssRegex = /([^{]+\{[\s\S]*?\})/g;
                let cssMatch;

                while ((cssMatch = cssRegex.exec(styleContent)) !== null) {
                    const cssItem = cssMatch[0].trim();
                    const selectorMatch = cssItem.match(/^([^{]+)/);
                    const name = selectorMatch ? selectorMatch[1].trim() : cssItem.split('{')[0].trim();

                    css.push({
                        name: name,
                        full: cssItem,
                        used: false
                    });
                }
            }

            return css;
        }

        function extractJS(html) {
            const js = [];

            const scriptRegex = /<script\b[^>]*>([\s\S]*?)<\/script>/gi;
            let scriptMatch;

            while ((scriptMatch = scriptRegex.exec(html)) !== null) {
                const scriptContent = scriptMatch[1];
                if (scriptContent.trim()) {
                    findFunctionDeclarations(scriptContent, js);
                    findFunctionExpressions(scriptContent, js);
                    findArrowFunctions(scriptContent, js);
                }
            }

            return js;
        }

        // Các hàm findFunction...
        function findFunctionDeclarations(content, result) {
            const functionRegex = /function\s+([a-zA-Z_$][a-zA-Z0-9_$]*)\s*\([^)]*\)\s*\{/g;
            let functionMatch;

            while ((functionMatch = functionRegex.exec(content)) !== null) {
                const funcName = functionMatch[1];
                const startIndex = functionMatch.index;

                let braceCount = 1;
                let currentIndex = functionMatch.index + functionMatch[0].length;

                while (braceCount > 0 && currentIndex < content.length) {
                    if (content[currentIndex] === '{') {
                        braceCount++;
                    } else if (content[currentIndex] === '}') {
                        braceCount--;
                    }
                    currentIndex++;
                }

                const fullCode = content.substring(startIndex, currentIndex).trim();

                result.push({
                    name: funcName,
                    fullCode: fullCode,
                    used: false
                });
            }
        }

        function findFunctionExpressions(content, result) {
            const expressionRegex = /(?:const|let|var)\s+([a-zA-Z_$][a-zA-Z0-9_$]*)\s*=\s*function\s*\([^)]*\)\s*\{/g;
            let expressionMatch;

            while ((expressionMatch = expressionRegex.exec(content)) !== null) {
                const funcName = expressionMatch[1];
                const startIndex = expressionMatch.index;

                let braceCount = 1;
                let currentIndex = expressionMatch.index + expressionMatch[0].length;

                while (braceCount > 0 && currentIndex < content.length) {
                    if (content[currentIndex] === '{') {
                        braceCount++;
                    } else if (content[currentIndex] === '}') {
                        braceCount--;
                    }
                    currentIndex++;
                }

                const fullCode = content.substring(startIndex, currentIndex).trim();

                result.push({
                    name: funcName,
                    fullCode: fullCode,
                    used: false
                });
            }
        }

        function findArrowFunctions(content, result) {
            const arrowRegex = /(?:const|let|var)\s+([a-zA-Z_$][a-zA-Z0-9_$]*)\s*=\s*\([^)]*\)\s*=>\s*\{/g;
            let arrowMatch;

            while ((arrowMatch = arrowRegex.exec(content)) !== null) {
                const funcName = arrowMatch[1];
                const startIndex = arrowMatch.index;

                let braceCount = 1;
                let currentIndex = arrowMatch.index + arrowMatch[0].length;

                while (braceCount > 0 && currentIndex < content.length) {
                    if (content[currentIndex] === '{') {
                        braceCount++;
                    } else if (content[currentIndex] === '}') {
                        braceCount--;
                    }
                    currentIndex++;
                }

                const fullCode = content.substring(startIndex, currentIndex).trim();

                result.push({
                    name: funcName,
                    fullCode: fullCode,
                    used: false
                });
            }
        }

        // Các hàm utility
        function analyzeUnusedCode(fileData) {
            fileData.css.forEach(css => {
                if (isCSSUsed(css.name, fileData.html)) {
                    css.used = true;
                }
            });

            fileData.js.forEach(js => {
                if (isJSUsed(js.name, fileData.html, fileData.js)) {
                    js.used = true;
                }
            });

            fileData.unused.css = fileData.css.filter(css => !css.used);
            fileData.unused.js = fileData.js.filter(js => !js.used);
            fileData.duplicates.css = findDuplicatesInFile(fileData.css);
            fileData.duplicates.js = findDuplicatesInFile(fileData.js);
        }

        function isCSSUsed(selector, html) {
            const simpleSelector = selector.split(' ')[0].split(':')[0].split('.')[0].split('#')[0];
            if (['body', 'html', 'head', 'title', 'meta', 'link', 'script', '*'].includes(simpleSelector)) {
                return true;
            }

            const classRegex = new RegExp(`class=["'][^"']*${simpleSelector}[^"']*["']`, 'i');
            const idRegex = new RegExp(`id=["']${simpleSelector}["']`, 'i');
            const tagRegex = new RegExp(`<${simpleSelector}[\\s>]`, 'i');

            return classRegex.test(html) || idRegex.test(html) || tagRegex.test(html);
        }

        function isJSUsed(funcName, html, allFunctions) {
            const htmlUsage = new RegExp(`\\b${funcName}\\s*\\(`, 'g').test(html);
            if (htmlUsage) return true;

            for (const otherFunc of allFunctions) {
                if (otherFunc.fullCode.includes(`${funcName}(`)) {
                    return true;
                }
            }

            return false;
        }

        function findDuplicatesInFile(items) {
            const duplicates = [];
            const seen = new Map();

            items.forEach(item => {
                if (seen.has(item.name)) {
                    duplicates.push(item);
                } else {
                    seen.set(item.name, item);
                }
            });

            return duplicates;
        }

        function analyzeFile(fileNum) {
            if (inputModes[`file${fileNum}`] === 'text') {
                updateFileContent(fileNum);
            }

            const fileData = analysisResults[`file${fileNum}`];
            if (!fileData.html || fileData.html.trim().length === 0) {
                showNotification(`Vui lòng nhập nội dung cho File ${fileNum} trước khi phân tích`, 'error');
                return;
            }

            const btn = document.getElementById(`analyze-btn-${fileNum}`);
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loading"></div> Đang phân tích...';
            btn.disabled = true;

            setTimeout(() => {
                try {
                    const css = extractCSS(fileData.html);
                    const js = extractJS(fileData.html);

                    fileData.css = css;
                    fileData.js = js;

                    analyzeUnusedCode(fileData);

                    document.getElementById(`file${fileNum}-stats`).textContent =
                        `${css.length} CSS, ${js.length} JS`;
                    document.getElementById(`file${fileNum}-stats`).className = 'badge badge-success';

                    displayFileAnalysis(fileNum);

                    showNotification(
                        `Đã phân tích File ${fileNum}: ${css.length} CSS, ${js.length} JS`,
                        'success'
                    );
                } catch (error) {
                    showNotification(`Lỗi khi phân tích File ${fileNum}: ${error.message}`, 'error');
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }, 500);
        }

        function displayFileAnalysis(fileNum) {
            const fileData = analysisResults[`file${fileNum}`];
            const analysisElement = document.getElementById(`analysis${fileNum}`);
            const countElement = document.getElementById(`analysis-${fileNum}-count`);

            let analysisHTML = '';

            analysisHTML += `<div class="analysis-section">
                <div class="section-title">📊 Tổng quan</div>
                <div class="section-content">
                    <div>• CSS Selectors: <strong>${fileData.css.length}</strong></div>
                    <div>• JS Functions: <strong>${fileData.js.length}</strong></div>
                </div>
            </div>`;

            analysisHTML += `<div class="analysis-section">
                <div class="section-title">🔄 Trùng lặp trong file</div>
                <div class="section-content">
                    <div>• CSS trùng: <strong>${fileData.duplicates.css.length}</strong></div>`;

            if (fileData.duplicates.css.length > 0) {
                analysisHTML += `<div class="item-list">`;
                fileData.duplicates.css.forEach(css => {
                    analysisHTML += `<span class="item-tag duplicate">${css.name}</span>`;
                });
                analysisHTML += `</div>`;
            }

            analysisHTML += `<div>• JS trùng: <strong>${fileData.duplicates.js.length}</strong></div>`;

            if (fileData.duplicates.js.length > 0) {
                analysisHTML += `<div class="item-list">`;
                fileData.duplicates.js.forEach(js => {
                    analysisHTML += `<span class="item-tag duplicate">${js.name}</span>`;
                });
                analysisHTML += `</div>`;
            }

            analysisHTML += `</div></div>`;

            analysisHTML += `<div class="analysis-section">
                <div class="section-title">🚫 Code không sử dụng</div>
                <div class="section-content">
                    <div>• CSS không dùng: <strong>${fileData.unused.css.length}</strong></div>`;

            if (fileData.unused.css.length > 0) {
                analysisHTML += `<div class="item-list">`;
                fileData.unused.css.forEach(css => {
                    analysisHTML += `<span class="item-tag unused">${css.name}</span>`;
                });
                analysisHTML += `</div>`;
            }

            analysisHTML += `<div>• JS không dùng: <strong>${fileData.unused.js.length}</strong></div>`;

            if (fileData.unused.js.length > 0) {
                analysisHTML += `<div class="item-list">`;
                fileData.unused.js.forEach(js => {
                    analysisHTML += `<span class="item-tag unused">${js.name}</span>`;
                });
                analysisHTML += `</div>`;
            }

            analysisHTML += `</div></div>`;

            analysisHTML += `<div class="analysis-section">
                <div class="section-title">🎨 Tất cả CSS Selectors</div>
                <div class="section-content">
                    <div class="item-list">`;

            fileData.css.forEach(css => {
                const statusClass = fileData.unused.css.some(c => c.name === css.name) ? 'unused' : '';
                analysisHTML += `<span class="item-tag ${statusClass}">${css.name}</span>`;
            });

            analysisHTML += `</div></div></div>`;

            analysisHTML += `<div class="analysis-section">
                <div class="section-title">⚙️ Tất cả JS Functions</div>
                <div class="section-content">
                    <div class="item-list">`;

            fileData.js.forEach(js => {
                const statusClass = fileData.unused.js.some(j => j.name === js.name) ? 'unused' : '';
                analysisHTML += `<span class="item-tag ${statusClass}">${js.name}</span>`;
            });

            analysisHTML += `</div></div></div>`;

            analysisElement.innerHTML = analysisHTML;
            countElement.textContent = `${fileData.css.length} CSS, ${fileData.js.length} JS`;
        }

        function analyzeBothFiles() {
            if (inputModes.file1 === 'text') updateFileContent(1);
            if (inputModes.file2 === 'text') updateFileContent(2);

            if (!analysisResults.file1.html || !analysisResults.file2.html) {
                showNotification('Vui lòng nhập nội dung cho cả hai file trước khi phân tích', 'error');
                return;
            }

            analyzeFile(1);
            setTimeout(() => analyzeFile(2), 600);
        }

        function compareFiles() {
            if (inputModes.file1 === 'text') updateFileContent(1);
            if (inputModes.file2 === 'text') updateFileContent(2);

            if (!analysisResults.file1.html || !analysisResults.file2.html) {
                showNotification('Vui lòng phân tích cả hai file trước khi so sánh', 'error');
                return;
            }

            const btn = document.getElementById('compare-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loading"></div> Đang so sánh...';
            btn.disabled = true;

            setTimeout(() => {
                try {
                    performComparison();
                    displayComparisonResults();
                    displayFileComparison(); // NEW: Hiển thị so sánh file chi tiết
                    displayMergeableFunctions(); // NEW: Hiển thị hàm có thể merge
                    showNotification('Đã hoàn thành so sánh!', 'success');
                } catch (error) {
                    showNotification(`Lỗi khi so sánh: ${error.message}`, 'error');
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }, 800);
        }

        function performComparison() {
            const comp = analysisResults.comparison;

            comp.duplicates = { css: [], js: [] };
            comp.similar = { css: [], js: [] };
            comp.missing = {
                file1: { css: [], js: [] },
                file2: { css: [], js: [] }
            };

            const f1 = analysisResults.file1;
            const f2 = analysisResults.file2;

            comp.duplicates.css = findExactDuplicates(f1.css, f2.css, 'css');
            comp.duplicates.js = findExactDuplicates(f1.js, f2.js, 'js');
            comp.similar.css = findSimilarButDifferent(f1.css, f2.css, 'css');
            comp.similar.js = findSimilarButDifferent(f1.js, f2.js, 'js');
            comp.missing.file1.css = findMissing(f2.css, f1.css);
            comp.missing.file1.js = findMissing(f2.js, f1.js);
            comp.missing.file2.css = findMissing(f1.css, f2.css);
            comp.missing.file2.js = findMissing(f1.js, f2.js);
        }

        function findExactDuplicates(arr1, arr2, type) {
            const duplicates = [];
            const map2 = new Map();

            arr2.forEach(item2 => {
                map2.set(item2.name, item2);
            });

            arr1.forEach(item1 => {
                if (map2.has(item1.name)) {
                    const item2 = map2.get(item1.name);
                    const code1 = type === 'css' ? item1.full : item1.fullCode;
                    const code2 = type === 'css' ? item2.full : item2.fullCode;

                    if (normalizeCode(code1) === normalizeCode(code2)) {
                        duplicates.push(item1);
                    }
                }
            });

            return duplicates;
        }

        function findSimilarButDifferent(arr1, arr2, type) {
            const similar = [];
            const map2 = new Map();

            arr2.forEach(item2 => {
                map2.set(item2.name, item2);
            });

            arr1.forEach(item1 => {
                if (map2.has(item1.name)) {
                    const item2 = map2.get(item1.name);
                    const code1 = type === 'css' ? item1.full : item1.fullCode;
                    const code2 = type === 'css' ? item2.full : item2.fullCode;

                    if (normalizeCode(code1) !== normalizeCode(code2)) {
                        similar.push({
                            ...item1,
                            otherVersion: item2
                        });
                    }
                }
            });

            return similar;
        }

        function findMissing(source, target) {
            const targetNames = new Set(target.map(item => item.name));
            return source.filter(item => !targetNames.has(item.name));
        }

        function normalizeCode(code) {
            return code
                .replace(/\s+/g, ' ')
                .replace(/\/\*[\s\S]*?\*\//g, '')
                .trim();
        }

        function displayComparisonResults() {
            const comp = analysisResults.comparison;

            const totalCss = analysisResults.file1.css.length + analysisResults.file2.css.length;
            const totalJs = analysisResults.file1.js.length + analysisResults.file2.js.length;

            document.getElementById('cssCount').textContent = totalCss;
            document.getElementById('jsCount').textContent = totalJs;
            document.getElementById('duplicateCount').textContent =
                comp.duplicates.css.length + comp.duplicates.js.length;
            document.getElementById('missingCount').textContent =
                comp.missing.file1.css.length + comp.missing.file1.js.length +
                comp.missing.file2.css.length + comp.missing.file2.js.length;

            document.getElementById('exact-css-count').textContent =
                `${comp.duplicates.css.length} phần tử`;
            document.getElementById('exact-js-count').textContent =
                `${comp.duplicates.js.length} phần tử`;

            document.getElementById('exactDuplicateCss').textContent =
                comp.duplicates.css.length > 0 ?
                    comp.duplicates.css.map(css => css.name).join('\n') :
                    'Không có CSS selectors trùng lặp hoàn toàn.';

            document.getElementById('exactDuplicateJs').textContent =
                comp.duplicates.js.length > 0 ?
                    comp.duplicates.js.map(js => js.name).join('\n') :
                    'Không có JavaScript functions trùng lặp hoàn toàn.';

            document.getElementById('similar-css-count').textContent =
                `${comp.similar.css.length} phần tử`;
            document.getElementById('similar-js-count').textContent =
                `${comp.similar.js.length} phần tử`;

            displaySimilarItems('css');
            displaySimilarItems('js');

            displayMissingItems();
        }

        function displaySimilarItems(type) {
            const element = document.getElementById(`similar${type === 'css' ? 'Css' : 'Js'}`);
            const items = analysisResults.comparison.similar[type];

            if (items.length > 0) {
                let html = '';
                items.forEach(item => {
                    const code1 = type === 'css' ? item.full : item.fullCode;
                    const code2 = type === 'css' ? item.otherVersion.full : item.otherVersion.fullCode;

                    html += `<div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--vs-border);">`;
                    html += `<strong>${type === 'css' ? 'CSS Selector' : 'JS Function'}: ${item.name}</strong>`;
                    html += `<div class="code-diff">`;
                    html += `<div class="code-side">`;
                    html += `<div class="code-side-header">File 1</div>`;
                    html += `<div class="code-side-content"><pre><code class="language-${type === 'css' ? 'css' : 'javascript'}">${escapeHtml(code1)}</code></pre></div>`;
                    html += `</div>`;
                    html += `<div class="code-side">`;
                    html += `<div class="code-side-header">File 2</div>`;
                    html += `<div class="code-side-content"><pre><code class="language-${type === 'css' ? 'css' : 'javascript'}">${escapeHtml(code2)}</code></pre></div>`;
                    html += `</div>`;
                    html += `</div>`;
                    html += `</div>`;
                });
                element.innerHTML = html;

                element.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            } else {
                element.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🔍</div>
                        <p>Không có ${type === 'css' ? 'CSS selectors' : 'JavaScript functions'} tương tự nhưng khác biệt.</p>
                    </div>
                `;
            }
        }

        function displayMissingItems() {
            const missing = analysisResults.comparison.missing;

            document.getElementById('missing-css-2-count').textContent =
                `${missing.file2.css.length} phần tử`;
            document.getElementById('missing-js-2-count').textContent =
                `${missing.file2.js.length} phần tử`;
            document.getElementById('missing-css-1-count').textContent =
                `${missing.file1.css.length} phần tử`;
            document.getElementById('missing-js-1-count').textContent =
                `${missing.file1.js.length} phần tử`;

            document.getElementById('missingCss2').textContent =
                missing.file2.css.length > 0 ?
                    missing.file2.css.map(css => css.name).join('\n') :
                    'Không có CSS selectors thiếu trong File 2.';

            document.getElementById('missingJs2').textContent =
                missing.file2.js.length > 0 ?
                    missing.file2.js.map(js => js.name).join('\n') :
                    'Không có JavaScript functions thiếu trong File 2.';

            document.getElementById('missingCss1').textContent =
                missing.file1.css.length > 0 ?
                    missing.file1.css.map(css => css.name).join('\n') :
                    'Không có CSS selectors thiếu trong File 1.';

            document.getElementById('missingJs1').textContent =
                missing.file1.js.length > 0 ?
                    missing.file1.js.map(js => js.name).join('\n') :
                    'Không có JavaScript functions thiếu trong File 1.';
        }

        // Hàm xóa file
        function clearFile(fileNum) {
            analysisResults[`file${fileNum}`] = {
                css: [], js: [], html: '', fileName: '', fileSize: 0,
                duplicates: { css: [], js: [] }, unused: { css: [], js: [] }
            };

            document.getElementById(`file-content-text-${fileNum}`).value = '';
            document.querySelector(`#file-content-preview-${fileNum} code`).textContent = '';
            document.getElementById(`file${fileNum}`).value = '';
            document.getElementById(`file-info-${fileNum}`).innerHTML = '';
            document.getElementById(`file${fileNum}-stats`).textContent = 'Chưa có nội dung';
            document.getElementById(`file${fileNum}-stats`).className = 'badge badge-info';
            document.getElementById(`analysis${fileNum}`).innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">📄</div>
                    <p>Chưa có dữ liệu. Vui lòng upload và phân tích File ${fileNum}.</p>
                </div>
            `;
            document.getElementById(`analysis-${fileNum}-count`).textContent = 'Chưa phân tích';

            updateLineCount(fileNum);
            updatePreviewLineCount(fileNum);
            updateTextDiffView();

            showNotification(`Đã xóa File ${fileNum}`, 'success');
        }

        function clearBothFiles() {
            clearFile(1);
            clearFile(2);
        }
    </script>
</body>

</html>
